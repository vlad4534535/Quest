<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Shooter: Mobile Remaster üì±</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #151520;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* –ë—ñ–ª—å—à –ø—Ä–∏—î–º–Ω–∏–π —à—Ä–∏—Ñ—Ç */
            color: white;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* --- UI: –í–ï–†–•–ù–Ø –ü–ê–ù–ï–õ–¨ --- */
        #game-ui {
            display: none;
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            pointer-events: none;
            z-index: 5;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); /* –ì—Ä–∞–¥—ñ—î–Ω—Ç –¥–ª—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ */
        }
        #top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            font-size: 14px;
            text-shadow: 1px 1px 2px black;
        }
        .hud-left, .hud-right {
            display: flex; flex-direction: column; gap: 4px;
        }
        .stat-row {
            display: flex; align-items: center; gap: 8px;
        }
        
        #mission-text {
            font-size: 18px; font-weight: 800; color: #44DDFF; text-transform: uppercase; letter-spacing: 1px;
        }

        /* –°–ú–£–ñ–ö–ò –ñ–ò–¢–¢–Ø –¢–ê XP - –∫–æ–º–ø–∞–∫—Ç–Ω—ñ */
        .bar-container {
            width: 140px; height: 8px;
            background: #333; border: 1px solid #777;
            border-radius: 4px; overflow: hidden;
            position: relative;
        }
        #health-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #00FF00, #00CC00); transition: width 0.2s; }
        #xp-bar-container { width: 140px; height: 4px; margin-top: 2px; border: none; background: #222; }
        #xp-fill { width: 0%; height: 100%; background: #0077FF; transition: width 0.2s; }
        #level-text { font-size: 10px; color: #00AAFF; font-weight: bold; margin-left: 2px;}

        /* --- –ú–ï–ù–Æ –¢–ê –ú–ê–ì–ê–ó–ò–ù (–ê–¥–∞–ø—Ç–∏–≤–Ω—ñ) --- */
        .overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(12, 18, 28, 0.96); /* –¢–µ–º–Ω–∏–π, –º–∞–π–∂–µ –Ω–µ–ø—Ä–æ–∑–æ—Ä–∏–π —Ñ–æ–Ω */
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; 
            z-index: 20;
            backdrop-filter: blur(5px);
        }
        h1 { margin: 0 0 10px 0; font-size: 24px; color: #00AAFF; text-align: center; text-transform: uppercase; letter-spacing: 2px; }
        h2 { margin: 0 0 15px 0; font-size: 14px; color: #aaa; }
        
        /* –ì—Ä—ñ–¥ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º—ñ—Å—ñ–π - –∑—Ä—É—á–Ω–æ –¥–ª—è –ø–∞–ª—å—Ü—ñ–≤ */
        .mission-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
            width: 90%; max-width: 500px;
            max-height: 50vh; overflow-y: auto;
            padding: 5px;
        }

        .btn {
            background: #252535; color: white;
            border: 1px solid #445566; border-radius: 8px;
            padding: 12px 5px;
            font-size: 13px; font-weight: bold;
            cursor: pointer; position: relative;
            font-family: inherit;
            box-shadow: 0 4px 0 #1a1a25;
            transition: transform 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 0; }
        .btn small { display: block; font-size: 10px; color: #8899aa; margin-top: 3px; font-weight: normal;}
        
        /* –ö–æ–ª—å–æ—Ä–∏ –∫–Ω–æ–ø–æ–∫ */
        .boss-btn { border-color: #A020F0; background: #2a1035; color: #E0E0E0; }
        .hard-btn { border-color: #FF3333; background: #351010; color: #FFAAAA; }
        .special-btn { border-color: #00FFCC; background: #002220; color: #AAFFFF; }
        
        .shop-btn { 
            background: linear-gradient(45deg, #FFD700, #FFA500); border: none; color: black; 
            width: 80%; max-width: 300px; margin-top: 15px; padding: 15px; font-size: 16px;
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
        }

        /* --- –ú–ê–ì–ê–ó–ò–ù (–ú–æ–±—ñ–ª—å–Ω–∏–π –≤–∏–≥–ª—è–¥) --- */
        #shop-screen { display: none; overflow-y: auto; padding: 20px 0; }
        .shop-container {
            display: flex; flex-direction: column; gap: 15px; 
            width: 90%; max-width: 500px; padding-bottom: 50px;
        }
        .shop-column {
            background: #1e1e28; padding: 15px; border-radius: 12px; border: 1px solid #334;
        }
        .shop-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #151520; margin-bottom: 8px; padding: 10px; border-radius: 8px;
        }
        .shop-item span { font-size: 14px; font-weight: bold; }
        .buy-btn {
            background: #333; border: 1px solid #555; color: white; 
            padding: 8px 12px; border-radius: 6px; font-size: 11px;
        }
        .buy-btn.owned { background: #1b3a1b; border-color: #2e8b2e; color: #7fff7f; }
        .buy-btn:active { transform: scale(0.95); }

        /* --- –ú–û–ë–Ü–õ–¨–ù–ï –ö–ï–†–£–í–ê–ù–ù–Ø (–ó–†–£–ß–ù–ï) --- */
        #mobile-controls {
            display: none; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; pointer-events: none; z-index: 10;
        }
        
        /* –î–∂–æ–π—Å—Ç–∏–∫–∏ - –ø—Ä–æ–∑–æ—Ä—ñ —Ç–∞ –º—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω—ñ */
        .joystick-zone {
            position: absolute; bottom: 40px;
            width: 140px; height: 140px; /* –ë—ñ–ª—å—à–∞ –∑–æ–Ω–∞ –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è */
            border-radius: 50%; pointer-events: auto;
            /* –õ–µ–≥–∫–∏–π –∫–æ–Ω—Ç—É—Ä, —â–æ–± –∑–Ω–∞—Ç–∏ –¥–µ –ø–∞–ª–µ—Ü—å */
            border: 2px solid rgba(255, 255, 255, 0.05); 
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 70%);
        }
        #stick-left { left: 20px; }
        #stick-right { right: 20px; }
        
        .joystick-knob {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 40px;
            border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none;
            /* –ö–æ–ª—ñ—Ä —Å—Ç–∞—î —è—Å–∫—Ä–∞–≤—ñ—à–∏–º –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ (—á–µ—Ä–µ–∑ JS –∫–ª–∞—Å active, –∞–ª–µ –ø–æ–∫–∏ —Ç–∞–∫) */
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #stick-right .joystick-knob { background: rgba(255, 50, 50, 0.2); }
        #stick-left .joystick-knob { background: rgba(0, 150, 255, 0.2); }

        /* –ö–Ω–æ–ø–∫–∞ –≥—Ä–∞–Ω–∞—Ç–∏ - –æ–∫—Ä–µ–º–æ —ñ –∑—Ä—É—á–Ω–æ */
        #mobile-grenade-btn {
            position: absolute; bottom: 160px; right: 40px;
            width: 50px; height: 50px;
            background: rgba(255, 100, 0, 0.2); 
            border: 2px solid rgba(255, 140, 0, 0.5);
            border-radius: 50%; color: white; font-size: 20px;
            display: flex; justify-content: center; align-items: center;
            pointer-events: auto; cursor: pointer;
            backdrop-filter: blur(2px);
        }
        #mobile-grenade-btn:active { background: rgba(255, 100, 0, 0.6); transform: scale(0.9); }

        /* –ü–∞–Ω–µ–ª—å –∑–±—Ä–æ—ó - –≤–µ–ª–∏–∫–∞ —ñ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        #weapon-bar {
            position: absolute; bottom: 10px; left: 50%;
            transform: translateX(-50%); 
            display: flex; gap: 8px; pointer-events: auto;
            background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 15px;
            backdrop-filter: blur(4px);
        }
        .wpn-btn {
            width: 42px; height: 42px; 
            background: #2a2a2a; border: 1px solid #444;
            color: #ddd; font-size: 9px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            border-radius: 8px; font-family: inherit; cursor: pointer;
            text-align: center; line-height: 1.1;
        }
        .wpn-btn.active { border-color: #00AAFF; background: #004466; color: white; box-shadow: 0 0 8px #00AAFF; }
        .wpn-btn.locked { opacity: 0.3; background: #111; border: none; }

        /* CHEAT BTN - Draggable */
        #santa-cheat-btn {
            display: none; position: absolute; top: 10px; right: 10px;
            width: 40px; height: 40px; background: rgba(255,255,255,0.9); border-radius: 50%;
            text-align: center; line-height: 40px; font-size: 24px;
            cursor: move; z-index: 1000; box-shadow: 0 0 15px cyan; pointer-events: auto;
        }
        #cheat-menu {
            display: none; position: absolute; background: rgba(0,0,0,0.95); border: 1px solid #00AAFF;
            padding: 15px; width: 180px; z-index: 999; border-radius: 12px; pointer-events: auto;
        }
        .cheat-option { margin-bottom: 12px; font-size: 14px; color: #00FF00; display: flex; justify-content: space-between; }
        
        #levelup-notify {
            position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%);
            font-size: 32px; color: #FFD700; font-weight: 900; text-shadow: 0 0 20px orange;
            pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 100; text-align: center; width: 100%;
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è Canvas */
        #gameCanvas { image-rendering: pixelated; } /* –Ø–∫—â–æ —Ö–æ—á–µ—à –ø—ñ–∫—Å–µ–ª—å–Ω–∏–π —Å—Ç–∏–ª—å */
    </style>
</head>
<body>

    <div id="santa-cheat-btn">üéÖ</div>
    <div id="cheat-menu">
        <div class="cheat-option"><label>AIMBOT</label><input type="checkbox" id="chk-aim" onchange="toggleCheat('aim')"></div>
        <div class="cheat-option"><label>WH (ESP)</label><input type="checkbox" id="chk-wh" onchange="toggleCheat('wh')"></div>
        <div class="cheat-option"><label>AUTO LOOT</label><input type="checkbox" id="chk-autoloot" onchange="toggleCheat('autoloot')"></div>
        <div class="cheat-option"><label>WALLBANG</label><input type="checkbox" id="chk-wallbang" onchange="toggleCheat('wallbang')"></div>
    </div>

    <div id="platform-screen" class="overlay" style="z-index: 30;">
        <h1>Tactical Shooter<br><span style="font-size: 0.6em; color: white;">‚ùÑÔ∏è New Year Edition ‚ùÑÔ∏è</span></h1>
        <h2 style="margin-top: 20px;">–û–±–µ—Ä—ñ—Ç—å —Ä–µ–∂–∏–º:</h2>
        <div style="display: flex; gap: 10px; flex-direction: column;">
            <button class="btn" style="width: 220px; font-size: 16px;" onclick="selectPlatform('MOBILE')">üì± –¢–ï–õ–ï–§–û–ù (–°–µ–Ω—Å–æ—Ä)</button>
            <button class="btn" style="width: 220px; font-size: 16px; background: #1a1a20; color:#888;" onclick="selectPlatform('PC')">üíª –ü–ö (–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞)</button>
        </div>
    </div>

    <div id="shop-screen" class="overlay" style="z-index: 25;">
        <h1 style="position: sticky; top: 0; background: rgba(12,18,28,0.95); width: 100%; padding: 10px 0; z-index: 2;">–ú–ê–ì–ê–ó–ò–ù</h1>
        <div style="color: #FFD700; font-size: 18px; margin-bottom: 10px;">üí∞ <span id="shop-coins">0</span></div>
        
        <div class="shop-container">
            <div class="shop-column" style="text-align: center;">
                <h3 style="margin-top: 0; color: #00AAFF;">–ü–ï–†–°–û–ù–ê–õ–Ü–ó–ê–¶–Ü–Ø</h3>
                <canvas id="previewCanvas" width="120" height="120" style="background: #111; border-radius: 50%; margin-bottom: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></canvas>
                <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                    <label>–ö–æ–ª—ñ—Ä:</label>
                    <input type="color" id="colorPicker" value="#0077FF" style="background: none; border: none; width: 40px; height: 40px;" onchange="updatePreview()">
                </div>
            </div>

            <div class="shop-column">
                <h3 style="margin-top: 0; color: #FF8800;">–û–î–Ø–ì</h3>
                <div id="accessories-list"></div>
            </div>

            <div class="shop-column">
                <h3 style="margin-top: 0; color: #FF3333;">–ê–†–°–ï–ù–ê–õ</h3>
                <div id="weapons-list"></div>
                
                <div class="promo-container" style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #444;">
                    <div style="font-size:11px; color:#888; margin-bottom:5px;">–ü–†–û–ú–û–ö–û–î:</div>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="promo-input" placeholder="..." style="flex:1; background: #111; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px;">
                        <button id="promo-btn" onclick="redeemCode()" style="background: #0077FF; color: white; border: none; padding: 0 15px; border-radius: 4px;">OK</button>
                    </div>
                </div>
            </div>
            
             <button class="btn" onclick="closeShop()" style="width: 100%; padding: 15px; background: #333; margin-top: 10px;">üîô –ù–ê–ó–ê–î –í –ú–ï–ù–Æ</button>
        </div>
    </div>

    <div id="menu-overlay" class="overlay" style="display: none;">
        <h1 id="menu-title">–ú–Ü–°–Ü–á</h1>
        <div class="menu-stats" style="display: flex; gap: 15px; font-size: 13px; color: #ccc;">
            <span>üéñÔ∏è LVL: <span id="menu-level" style="color:white;">1</span></span>
            <span>‚ò†Ô∏è KILLS: <span id="menu-kills" style="color:white;">0</span></span>
            <span>üí∞ CASH: <span id="menu-coins" style="color:#FFD700;">0</span></span>
        </div>
        
        <div id="menu-buttons" class="mission-grid">
            <button class="btn" onclick="startMission(1)">–û–ö–û–ü<br><small>–í–∏–∂–∏—Ç–∏ 20—Å</small></button>
            <button class="btn" onclick="startMission(2)">–ó–ê–ß–ò–°–¢–ö–ê<br><small>5 –≤–æ—Ä–æ–≥—ñ–≤</small></button>
            <button class="btn boss-btn" onclick="startMission(3)">–ë–û–°<br><small>–õ—ñ–∫–≤—ñ–¥–∞—Ü—ñ—è</small></button>
            <button class="btn" onclick="startMission(4)">–û–†–î–ê<br><small>–í–∏–∂–∏—Ç–∏ 40—Å</small></button>
            <button class="btn" onclick="startMission(5)">–ú'–Ø–°–û<br><small>–í–±–∏—Ç–∏ 50</small></button>
            <button class="btn hard-btn" onclick="startMission(6)">–•–ê–†–î<br><small>60 —Å–µ–∫</small></button>
            <button class="btn grenade-mission-btn" onclick="startMission(7)">–ü–Ü–î–†–ò–í<br><small>15 –±–æ–º–±</small></button>
            <button class="btn hard-btn" onclick="startMission(8)">–ê–ü–û–ö–ê–õ–Ü–ü–°–ò–°<br><small>50 —Å–µ–∫</small></button>
            <button class="btn special-btn" onclick="startMission(9)">–ó–ê–•–í–ê–¢<br><small>–ó–æ–Ω–∞ 15—Å</small></button>
            <button class="btn special-btn" onclick="startMission(10)">–¢–ï–ú–†–Ø–í–ê<br><small>–õ—ñ—Ö—Ç–∞—Ä–∏–∫</small></button>
            <button class="btn special-btn" onclick="startMission(11)">–°–ù–ê–ô–ü–ï–†<br><small>–í–ª—É—á–Ω—ñ—Å—Ç—å</small></button>
        </div>
        <button class="btn shop-btn" onclick="openShop()">üõí –ú–ê–ì–ê–ó–ò–ù</button>
        <button id="end-game-btn" class="btn" onclick="showMainMenu()" style="display:none; background: #FF3333; margin-top: 20px; width: 200px;">–í –ì–û–õ–û–í–ù–ï –ú–ï–ù–Æ</button>
    </div>

    <div id="game-ui">
        <div id="top-bar">
            <div class="hud-left">
                <div id="mission-text">–¶–Ü–õ–¨</div>
                <div class="bar-container" id="health-bar"><div id="health-fill"></div></div>
                <div class="stat-row">
                     <div id="xp-bar-container"><div id="xp-fill"></div></div>
                     <span id="level-text">LVL 1</span>
                </div>
            </div>
            <div class="hud-right" style="align-items: flex-end;">
                <div class="stat-row" style="color: #ccc;">‚è±Ô∏è <span id="stats" style="color: white; font-weight: bold;">0</span></div>
                <div class="stat-row" style="color: #FFA500;">üí£ <span id="grenade-counter">3</span></div>
                <div class="stat-row" style="color: #FFD700;">üí∞ <span id="coin-counter">0</span></div>
            </div>
        </div>
    </div>
    
    <div id="levelup-notify">LEVEL UP!</div>

    <div id="mobile-controls">
        <div id="stick-left" class="joystick-zone"><div class="joystick-knob" id="knob-left"></div></div>
        <div id="stick-right" class="joystick-zone"><div class="joystick-knob" id="knob-right"></div></div>
        <div id="mobile-grenade-btn" onclick="throwGrenadeMobile()">üí£</div>
        <div id="weapon-bar"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // –ü–æ–∫—Ä–∞—â–µ–Ω–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—ñ–≤ (High DPI)
        function resize() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            ctx.scale(dpr, dpr);
            // –í–∞–∂–ª–∏–≤–æ: –ª–æ–≥—ñ—á–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏ canvas –º–∞—é—Ç—å –∑–±—ñ–≥–∞—Ç–∏—Å—è –∑ CSS —Ä–æ–∑–º—ñ—Ä–∞–º–∏ –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ—ó –º–∏—à—ñ/—Ç–∞—á—ñ–≤
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
        }
        window.addEventListener('resize', resize);
        resize();

        // –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ä–æ–∑–º—ñ—Ä—ñ–≤ –ª–æ–≥—ñ—á–Ω–æ–≥–æ –µ–∫—Ä–∞–Ω—É (–±–æ canvas.width —Ç–µ–ø–µ—Ä –≤–µ–ª–∏–∫–∏–π)
        function getW() { return window.innerWidth; }
        function getH() { return window.innerHeight; }

        let playerStats = {
            totalKills: 0, coins: 0, color: '#0077FF', xp: 0, level: 1, nextLevelXp: 100,
            unlockedWeapons: ['pistol', 'rifle', 'shotgun', 'sniper'],
            unlockedOutfits: ['none'], currentOutfit: 'none', redeemedCodes: [], cheatsUnlocked: false 
        };
        
        let activeCheats = { aim: false, wh: false, autoloot: false, wallbang: false };

        function toggleCheatMenu() {
            let menu = document.getElementById('cheat-menu');
            let btn = document.getElementById('santa-cheat-btn');
            if (menu.style.display !== 'block') {
                const rect = btn.getBoundingClientRect();
                menu.style.top = (rect.bottom + 5) + 'px';
                let leftPos = rect.left - (menu.offsetWidth - rect.width)/2;
                if(leftPos + 200 > window.innerWidth) leftPos = window.innerWidth - 210;
                if(leftPos < 0) leftPos = 10;
                menu.style.left = leftPos + 'px';
            }
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function toggleCheat(type) {
            if (type === 'aim') activeCheats.aim = document.getElementById('chk-aim').checked;
            if (type === 'wh') activeCheats.wh = document.getElementById('chk-wh').checked;
            if (type === 'autoloot') activeCheats.autoloot = document.getElementById('chk-autoloot').checked;
            if (type === 'wallbang') activeCheats.wallbang = document.getElementById('chk-wallbang').checked;
        }

        // --- DRAGGABLE SANTA ---
        const santaBtn = document.getElementById('santa-cheat-btn');
        let dragObj = null; let dragOffsetX = 0; let dragOffsetY = 0; let isDraggingCheat = false;

        const startDrag = (clientX, clientY) => {
            isDraggingCheat = false; dragObj = santaBtn;
            const rect = santaBtn.getBoundingClientRect();
            dragOffsetX = clientX - rect.left; dragOffsetY = clientY - rect.top;
        };
        const moveDrag = (clientX, clientY) => {
            if (dragObj) {
                isDraggingCheat = true;
                let newLeft = clientX - dragOffsetX; let newTop = clientY - dragOffsetY;
                newLeft = Math.max(0, Math.min(window.innerWidth - dragObj.offsetWidth, newLeft));
                newTop = Math.max(0, Math.min(window.innerHeight - dragObj.offsetHeight, newTop));
                dragObj.style.left = newLeft + 'px'; dragObj.style.top = newTop + 'px';
                document.getElementById('cheat-menu').style.display = 'none';
            }
        };
        santaBtn.addEventListener('mousedown', e => { if(e.button===0) startDrag(e.clientX, e.clientY); });
        santaBtn.addEventListener('touchstart', e => { startDrag(e.touches[0].clientX, e.touches[0].clientY); e.preventDefault(); }, {passive: false});
        window.addEventListener('mousemove', e => moveDrag(e.clientX, e.clientY));
        window.addEventListener('touchmove', e => moveDrag(e.touches[0].clientX, e.touches[0].clientY));
        window.addEventListener('mouseup', () => { if(dragObj && !isDraggingCheat) toggleCheatMenu(); dragObj = null; });
        window.addEventListener('touchend', () => { if(dragObj && !isDraggingCheat) toggleCheatMenu(); dragObj = null; });

        // --- PROGRESSION ---
        function getNextLevelXp(lvl) { return Math.floor(100 * Math.pow(1.2, lvl - 1)); }
        function addPlayerXp(amount) {
            playerStats.xp += amount;
            if (playerStats.xp >= playerStats.nextLevelXp) levelUp();
            updateUI();
        }
        function levelUp() {
            playerStats.xp -= playerStats.nextLevelXp; playerStats.level++;
            playerStats.nextLevelXp = getNextLevelXp(playerStats.level);
            playerStats.coins += 50 * playerStats.level;
            if (player) player.hp = player.maxHp;
            showLevelUpEffect(); saveGame();
            if (playerStats.xp >= playerStats.nextLevelXp) levelUp();
        }
        function showLevelUpEffect() {
            const el = document.getElementById('levelup-notify');
            el.style.opacity = 1; el.style.top = '30%';
            setTimeout(() => { el.style.opacity = 0; el.style.top = '20%'; }, 2000);
        }

        // --- SAVE/LOAD ---
        function loadGame() {
            let saved = localStorage.getItem('tacticalShooterData_v3'); // v3 for mobile fix
            if (saved) {
                let parsed = JSON.parse(saved);
                playerStats = { ...playerStats, ...parsed };
                playerStats.nextLevelXp = getNextLevelXp(playerStats.level);
                if(playerStats.cheatsUnlocked) document.getElementById('santa-cheat-btn').style.display = 'block';
            }
            updateMenuStats();
        }
        function saveGame() { localStorage.setItem('tacticalShooterData_v3', JSON.stringify(playerStats)); updateMenuStats(); }
        function updateMenuStats() {
            document.getElementById('menu-kills').innerText = playerStats.totalKills;
            document.getElementById('menu-coins').innerText = playerStats.coins;
            document.getElementById('menu-level').innerText = playerStats.level;
        }

        // --- SHOP ---
        const shopItems = {
            outfits: [
                { id: 'none', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', price: 0 },
                { id: 'santa_hat', name: 'üéÖ –®–∞–ø–∫–∞', price: 0 },
                { id: 'cap', name: 'üß¢ –ö–µ–ø–∫–∞', price: 150 },
                { id: 'helmet', name: 'ü™ñ –ö–∞—Å–∫–∞', price: 300 },
                { id: 'vest', name: 'üõ°Ô∏è –ñ–∏–ª–µ—Ç', price: 500 }
            ],
            weapons: [
                { id: 'minigun', name: '–ö–£–õ–ï–ú–ï–¢ (LVL 5)', price: 1000, levelReq: 5 }
            ]
        };
        const previewCanvas = document.getElementById('previewCanvas');
        const pCtx = previewCanvas.getContext('2d');

        function openShop() {
            document.getElementById('menu-overlay').style.display = 'none';
            document.getElementById('shop-screen').style.display = 'block'; // Block instead of flex for scroll
            document.getElementById('shop-coins').innerText = playerStats.coins;
            renderShopItems(); updatePreview();
        }
        function closeShop() {
            saveGame();
            document.getElementById('shop-screen').style.display = 'none';
            document.getElementById('menu-overlay').style.display = 'flex';
        }
        function renderShopItems() {
            const accList = document.getElementById('accessories-list'); accList.innerHTML = '';
            shopItems.outfits.forEach(item => {
                let div = document.createElement('div'); div.className = 'shop-item';
                let owned = playerStats.unlockedOutfits.includes(item.id);
                let equipped = playerStats.currentOutfit === item.id;
                let btnText = owned ? (equipped ? '‚úì' : '–û–î–Ø–ì–¢–ò') : `${item.price}$`;
                let btnClass = equipped ? 'buy-btn owned' : (owned ? 'buy-btn' : 'buy-btn');
                if(equipped) btnClass += ' owned';
                div.innerHTML = `<span>${item.name}</span> <button class="${btnClass}" onclick="handleShopAction('outfit', '${item.id}', ${item.price})">${btnText}</button>`;
                accList.appendChild(div);
            });
            const wpnList = document.getElementById('weapons-list'); wpnList.innerHTML = '';
            shopItems.weapons.forEach(item => {
                let div = document.createElement('div'); div.className = 'shop-item';
                let owned = playerStats.unlockedWeapons.includes(item.id);
                let locked = item.levelReq && playerStats.level < item.levelReq;
                let btnText = owned ? '–ö–£–ü–õ–ï–ù–û' : (locked ? `LVL ${item.levelReq}` : `${item.price}$`);
                let btnClass = owned ? 'buy-btn owned' : 'buy-btn';
                div.innerHTML = `<span>${item.name}</span> <button class="${btnClass}" onclick="handleShopAction('weapon', '${item.id}', ${item.price})" ${locked||owned ? 'disabled' : ''}>${btnText}</button>`;
                wpnList.appendChild(div);
            });
        }
        function handleShopAction(type, id, price) {
            if (type === 'outfit') {
                if (playerStats.unlockedOutfits.includes(id)) playerStats.currentOutfit = id;
                else if (playerStats.coins >= price) {
                    playerStats.coins -= price; playerStats.unlockedOutfits.push(id); playerStats.currentOutfit = id;
                }
            } else if (type === 'weapon') {
                if (!playerStats.unlockedWeapons.includes(id) && playerStats.coins >= price) {
                    playerStats.coins -= price; playerStats.unlockedWeapons.push(id);
                }
            }
            updatePreview(); renderShopItems(); document.getElementById('shop-coins').innerText = playerStats.coins;
        }
        function updatePreview() {
            let color = document.getElementById('colorPicker').value; playerStats.color = color;
            pCtx.clearRect(0,0,120,120); pCtx.save(); pCtx.translate(60, 60); pCtx.scale(2.5, 2.5);
            pCtx.beginPath(); pCtx.arc(0, 0, 15, 0, Math.PI * 2); pCtx.fillStyle = color; pCtx.fill();
            pCtx.strokeStyle = '#000'; pCtx.lineWidth = 1; pCtx.stroke();
            if (playerStats.currentOutfit === 'santa_hat') {
                pCtx.fillStyle = '#D40000'; pCtx.beginPath(); pCtx.moveTo(-15, -5); pCtx.lineTo(15, -5); pCtx.lineTo(0, -28); pCtx.fill();
                pCtx.fillStyle = '#FFFFFF'; pCtx.fillRect(-16, -5, 32, 6); pCtx.beginPath(); pCtx.arc(0, -28, 5, 0, Math.PI*2); pCtx.fill();
            } else if (playerStats.currentOutfit === 'helmet') {
                pCtx.fillStyle = '#334400'; pCtx.beginPath(); pCtx.arc(0, 0, 16, Math.PI, 0); pCtx.fill();
                pCtx.fillStyle = '#223300'; pCtx.fillRect(-15, -5, 30, 5);
            } else if (playerStats.currentOutfit === 'vest') {
                 pCtx.fillStyle = '#2E3B22'; pCtx.fillRect(-14, -14, 28, 28);
                 pCtx.fillStyle = '#4A5D3A'; pCtx.fillRect(-10, 2, 8, 10); pCtx.fillRect(2, 2, 8, 10);
            } else if (playerStats.currentOutfit === 'cap') {
                pCtx.fillStyle = '#C2B280'; pCtx.beginPath(); pCtx.arc(0, 0, 15, Math.PI * 0.8, Math.PI * 3.2); pCtx.fill();
                pCtx.fillStyle = '#A09165'; pCtx.fillRect(13, -13, 14, 26);
            }
            pCtx.fillStyle = '#000'; pCtx.fillRect(10, -3, 15, 6); pCtx.restore();
        }
        function redeemCode() {
            const code = document.getElementById('promo-input').value.trim().toUpperCase();
            const secret = "FHJWIDFNN2137217^$&*@JFUHIWHAAHSDN2273871287873201JDFJHWOMF%(#&$(*@&";
            if (playerStats.redeemedCodes.includes(code)) { alert("–í–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ!"); return; }
            let s = false; let m = "";
            if (code === secret) { playerStats.cheatsUnlocked = true; document.getElementById('santa-cheat-btn').style.display = 'block'; m = "–°–ï–ö–†–ï–¢ –í–Ü–î–ö–†–ò–¢–û!"; s = true; }
            else if (code === 'NEWYEAR2026') { if(!playerStats.unlockedWeapons.includes('snowball')) { playerStats.unlockedWeapons.push('snowball'); m="–°–Ω—ñ–≥–æ–º–µ—Ç!"; s=true; } }
            else if (code === 'DAVX5H8KD') { playerStats.coins += 1000; if(playerStats.level<5) playerStats.level=5; if(!playerStats.unlockedWeapons.includes('minigun')) playerStats.unlockedWeapons.push('minigun'); m="–ë–û–ù–£–°!"; s=true;}
            
            if (s) { playerStats.redeemedCodes.push(code); saveGame(); alert(m); document.getElementById('promo-input').value=""; }
            else { alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –∫–æ–¥"); }
        }

        // --- GAME CORE ---
        const PLAYER_SPEED = 4.5; const BULLET_SPEED = 14;
        let controlMode = 'PC'; let gameState = 'PLATFORM_SELECT'; let currentMissionId = 0;
        let gameTime = 0; let enemiesKilled = 0; let grenadesKilled = 0; let bossSpawned = false;
        let zoneTimer = 0; let captureZone = { x: 0, y: 0, radius: 100 }; let screenShake = 0;
        let obstacles = [], bullets = [], enemies = [], particles = [], drops = [], thrownGrenades = [], decorations = [], snowflakes = [];
        let player;
        let keys = {}; let mouse = { x: 0, y: 0, down: false };
        let joystickLeft = { x: 0, y: 0, active: false, id: null };
        let joystickRight = { x: 0, y: 0, active: false, id: null };
        let lastAimAngle = 0;

        for(let i=0; i<60; i++) snowflakes.push({x: Math.random()*getW(), y: Math.random()*getH(), r: Math.random()*2+0.5, s: Math.random()*1+0.2});

        // CLASSES
        class DropItem {
            constructor(x, y, type) { this.x = x; this.y = y; this.type = type; this.size = 20; this.bob = Math.random()*Math.PI*2; }
            draw() {
                let Y = this.y + Math.sin(gameTime*5 + this.bob)*3;
                if(this.type==='medkit') { ctx.fillStyle='#0C0'; ctx.fillRect(this.x-10,Y-10,20,20); ctx.fillStyle='#FFF'; ctx.fillRect(this.x-3,Y-8,6,16); ctx.fillRect(this.x-8,Y-3,16,6); }
                else if(this.type==='grenade') { ctx.fillStyle='#F80'; ctx.beginPath(); ctx.arc(this.x,Y,10,0,Math.PI*2); ctx.fill(); ctx.fillStyle='black'; ctx.fillText('üí£', this.x-6, Y+5); }
                else { ctx.fillStyle='#FF0'; ctx.beginPath(); ctx.arc(this.x,Y,10,0,Math.PI*2); ctx.fill(); ctx.fillStyle='black'; ctx.font='bold 12px Arial'; ctx.fillText('$', this.x-4, Y+4); }
            }
        }
        class GrenadeObj {
            constructor(x, y, tx, ty) {
                this.x = x; this.y = y; this.timer = 60; this.dead = false;
                let a = Math.atan2(ty-y, tx-x); let d = Math.hypot(tx-x, ty-y); let s = Math.min(d/20, 10);
                this.vx = Math.cos(a)*s; this.vy = Math.sin(a)*s; this.fly = Math.floor(d/s);
            }
            update() { if(this.fly>0) { this.x+=this.vx; this.y+=this.vy; this.fly--; } this.timer--; if(this.timer<=0) { this.explode(); this.dead=true; } }
            explode() {
                createExplosion(this.x, this.y); screenShake = 15;
                enemies.forEach(en => { if(Math.hypot(en.x-this.x, en.y-this.y)<120) { en.takeDamage(150); if(en.hp<=0) grenadesKilled++; } });
            }
            draw() { ctx.beginPath(); ctx.arc(this.x, this.y, 6, 0, Math.PI*2); ctx.fillStyle = Math.floor(this.timer/5)%2===0?'red':'yellow'; ctx.fill(); }
        }
        class Rect {
            constructor(x, y, size) { this.x = x; this.y = y; this.size = size; }
            draw() {
                ctx.fillStyle = '#445'; ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.fillStyle = '#DDE'; ctx.beginPath(); ctx.moveTo(this.x-2,this.y); ctx.lineTo(this.x+this.size+2,this.y); ctx.lineTo(this.x+this.size+2,this.y+15);
                for(let i=0; i<this.size; i+=10) ctx.arc(this.x+this.size-i, this.y+15, 5, 0, Math.PI);
                ctx.lineTo(this.x-2,this.y+15); ctx.fill();
            }
        }
        class Entity {
            constructor(x, y, r, c, hp) { this.x = x; this.y = y; this.radius = r; this.color = c; this.hp = hp; this.maxHp = hp; this.dead = false; this.cooldown = 0; }
            drawBase() { ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2); ctx.fillStyle = this.color; ctx.fill(); ctx.strokeStyle = 'black'; ctx.lineWidth = 2; ctx.stroke(); }
            drawHealthBar() {
                if(this.hp < this.maxHp || this instanceof Player) {
                    ctx.save(); ctx.fillStyle = 'white'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center'; 
                    ctx.shadowColor='black'; ctx.shadowBlur=3; ctx.fillText(Math.ceil(this.hp), this.x, this.y - this.radius - 12); ctx.restore();
                }
                if(this.hp < this.maxHp) {
                    let w = this.radius * 2; ctx.fillStyle = 'red'; ctx.fillRect(this.x-w/2, this.y-this.radius-8, w, 4);
                    ctx.fillStyle = '#0F0'; ctx.fillRect(this.x-w/2, this.y-this.radius-8, w*(this.hp/this.maxHp), 4);
                }
            }
            move(dx, dy) {
                if(!this.checkWall(this.x+dx, this.y)) this.x+=dx;
                if(!this.checkWall(this.x, this.y+dy)) this.y+=dy;
                this.x = Math.max(this.radius, Math.min(getW()-this.radius, this.x));
                this.y = Math.max(this.radius, Math.min(getH()-this.radius, this.y));
            }
            checkWall(x, y) {
                for(let o of obstacles) {
                    let cx = Math.max(o.x, Math.min(x, o.x+o.size)); let cy = Math.max(o.y, Math.min(y, o.y+o.size));
                    if((x-cx)**2 + (y-cy)**2 < this.radius**2) return true;
                } return false;
            }
        }

        class Player extends Entity {
            constructor(x, y) { super(x, y, 15, playerStats.color, 100); this.weapon='pistol'; this.grenades=3; this.angle=0; }
            draw() {
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fillStyle = playerStats.color; ctx.fill(); ctx.strokeStyle='black'; ctx.stroke();
                // Outfit
                if (playerStats.currentOutfit === 'santa_hat') {
                    ctx.fillStyle = '#D00'; ctx.beginPath(); ctx.moveTo(-15, -5); ctx.lineTo(15, -5); ctx.lineTo(0, -28); ctx.fill();
                    ctx.fillStyle = '#FFF'; ctx.fillRect(-16, -5, 32, 6); ctx.beginPath(); ctx.arc(0, -28, 5, 0, Math.PI*2); ctx.fill();
                } else if (playerStats.currentOutfit === 'helmet') {
                    ctx.fillStyle = '#340'; ctx.beginPath(); ctx.arc(0, 0, 16, Math.PI, 0); ctx.fill(); ctx.fillRect(-15, -5, 30, 5);
                } else if (playerStats.currentOutfit === 'cap') {
                    ctx.fillStyle = '#CB8'; ctx.beginPath(); ctx.arc(0, 0, 15, Math.PI*0.8, Math.PI*3.2); ctx.fill(); ctx.fillStyle='#A96'; ctx.fillRect(13, -13, 14, 26);
                } else if (playerStats.currentOutfit === 'vest') {
                     ctx.fillStyle = '#232'; ctx.fillRect(-14, -14, 28, 28);
                }
                // Weapon
                if (this.weapon === 'snowball') { ctx.fillStyle = '#0FF'; ctx.fillRect(10, -5, 20, 10); ctx.beginPath(); ctx.arc(10, 0, 5, 0, Math.PI*2); ctx.fill(); } 
                else { ctx.fillStyle = 'black'; ctx.fillRect(10, -3, 15, 6); }
                ctx.restore();
            }
            update() {
                if(this.cooldown>0) this.cooldown--;
                let dx=0, dy=0;
                // Cheat: Aim
                if(activeCheats.aim && enemies.length>0) {
                    let cl = enemies.reduce((a, b) => Math.hypot(a.x-this.x, a.y-this.y) < Math.hypot(b.x-this.x, b.y-this.y) ? a : b);
                    this.angle = Math.atan2(cl.y-this.y, cl.x-this.x); lastAimAngle = this.angle;
                }
                // Cheat: Loot
                if(activeCheats.autoloot && drops.length>0) { this.x = drops[0].x; this.y = drops[0].y; }
                
                if (controlMode === 'PC') {
                    ['Digit1','Digit2','Digit3','Digit4','Digit5','Digit6'].forEach((k,i) => { if(keys[k]) this.setWpn(['pistol','rifle','shotgun','sniper','minigun','snowball'][i]); });
                    if(keys['Space']) this.throwG(mouse.x, mouse.y);
                    if(keys['KeyW']) dy = -PLAYER_SPEED; if(keys['KeyS']) dy = PLAYER_SPEED; if(keys['KeyA']) dx = -PLAYER_SPEED; if(keys['KeyD']) dx = PLAYER_SPEED;
                    if(dx&&dy) { dx*=0.707; dy*=0.707; }
                    if(!activeCheats.aim) { this.angle = Math.atan2(mouse.y-this.y, mouse.x-this.x); lastAimAngle=this.angle; }
                    if(mouse.down) this.shoot(this.angle);
                } else {
                    if(joystickLeft.active) { dx = joystickLeft.x*PLAYER_SPEED; dy = joystickLeft.y*PLAYER_SPEED; }
                    if(joystickRight.active) {
                        if(!activeCheats.aim) { this.angle = Math.atan2(joystickRight.y, joystickRight.x); lastAimAngle=this.angle; }
                        this.shoot(this.angle);
                    } else if((dx||dy) && !activeCheats.aim) this.angle = Math.atan2(dy, dx);
                }
                this.move(dx, dy);
            }
            setWpn(w) { 
                if((w==='minigun' && playerStats.level<5) || !playerStats.unlockedWeapons.includes(w)) return;
                this.weapon = w; updateUI(); 
            }
            throwG(tx, ty) { if(this.grenades>0) { this.grenades--; thrownGrenades.push(new GrenadeObj(this.x, this.y, tx, ty)); updateUI(); } }
            shoot(a) {
                if(this.cooldown>0) return;
                if(this.weapon==='shotgun'||this.weapon==='sniper') screenShake=5;
                let s = BULLET_SPEED;
                if(this.weapon==='pistol') this.b(a,0,20,20,s);
                else if(this.weapon==='rifle') this.b(a,(Math.random()-0.5)*0.2,10,6,s);
                else if(this.weapon==='shotgun') { this.b(a,0,15,45,s); this.b(a+0.15,0,15,45,s); this.b(a-0.15,0,15,45,s); }
                else if(this.weapon==='sniper') this.b(a,0,100,60,25);
                else if(this.weapon==='minigun') { this.b(a,(Math.random()-0.5)*0.4,8,3,s); screenShake=2; }
                else if(this.weapon==='snowball') this.b(a,0,10000,30,10,'snowball');
            }
            b(a, spr, dmg, cd, spd, type='normal') {
                bullets.push(new Bullet(this.x, this.y, {x:Math.cos(a+spr)*spd, y:Math.sin(a+spr)*spd}, false, dmg, type==='snowball'?8:4, type));
                this.cooldown = cd;
            }
        }

        class Enemy extends Entity {
            constructor(x, y, type) {
                let r=15, h=40, c='#F33', s=2.5;
                if(type==='boss') { r=40; h=600; c='#A0F'; s=1.5; }
                if(currentMissionId===6) s*=1.4; if(currentMissionId===8) s*=1.2;
                super(x, y, r, c, h); this.type=type; this.speed=s;
            }
            draw() {
                let a = 0; if(player) a = Math.atan2(player.y-this.y, player.x-this.x);
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(a);
                ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fillStyle=this.color; ctx.fill(); ctx.stroke();
                ctx.fillStyle = this.type==='boss'?'#404':'#500'; ctx.fillRect(this.radius-2, -3, this.type==='boss'?25:15, 6);
                ctx.restore(); this.drawHealthBar();
            }
            update() {
                if(this.cooldown>0) this.cooldown--;
                let d = Math.hypot(player.x-this.x, player.y-this.y); let a = Math.atan2(player.y-this.y, player.x-this.x);
                if(d > 150+this.radius) this.move(Math.cos(a)*this.speed, Math.sin(a)*this.speed);
                else if(d < 100) this.move(-Math.cos(a)*this.speed*0.5, -Math.sin(a)*this.speed*0.5);
                
                if(d < (this.type==='boss'?600:400) && Math.random() < (this.type==='boss'?0.1:0.03)) {
                    let dmg = this.type==='boss'?25:10;
                    bullets.push(new Bullet(this.x, this.y, {x:Math.cos(a)*BULLET_SPEED, y:Math.sin(a)*BULLET_SPEED}, true, dmg, this.type==='boss'?8:4));
                    this.cooldown=40;
                }
            }
            takeDamage(amt) {
                this.hp-=amt;
                if(this.hp<=0 && !this.dead) {
                    this.dead=true; playerStats.totalKills++; addPlayerXp(this.type==='boss'?100:10);
                    for(let i=0;i<5;i++) particles.push({x:this.x,y:this.y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:15,c:this.color});
                    if(Math.random()<0.3) drops.push(new DropItem(this.x, this.y, 'coin'));
                    else if(Math.random()<0.2) drops.push(new DropItem(this.x, this.y, Math.random()<0.5?'medkit':'grenade'));
                }
            }
        }

        class Bullet {
            constructor(x, y, v, en, d, r, t) { this.x=x; this.y=y; this.v=v; this.isEnemy=en; this.dmg=d; this.radius=r; this.dead=false; this.type=t; }
            update() {
                this.x+=this.v.x; this.y+=this.v.y;
                if(!activeCheats.wallbang || this.isEnemy) { // Cheat: Wallbang
                    for(let o of obstacles) if(this.x>o.x && this.x<o.x+o.size && this.y>o.y && this.y<o.y+o.size) { this.dead=true; return; }
                }
                if(this.x<0||this.x>getW()||this.y<0||this.y>getH()) this.dead=true;
            }
            draw() { 
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2); 
                ctx.fillStyle = this.type==='snowball'?'white':(this.isEnemy?'orange':'yellow'); ctx.fill(); 
            }
        }

        function createExplosion(x, y) { for(let i=0;i<20;i++) particles.push({x,y,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,life:30,c:'orange'}); }

        // --- PLATFORM & UI ---
        function selectPlatform(mode) {
            controlMode = mode; document.getElementById('platform-screen').style.display = 'none';
            loadGame(); showMainMenu(); setupMobileWeapons();
            if(mode==='MOBILE') {
                document.getElementById('mobile-controls').style.display = 'block';
            }
        }
        function setupMobileWeapons() {
            const bar = document.getElementById('weapon-bar'); bar.innerHTML = '';
            ['pistol', 'rifle', 'shotgun', 'sniper', 'minigun', 'snowball'].forEach(k => {
                if((k==='minigun' && playerStats.level<5) || (k==='snowball' && !playerStats.unlockedWeapons.includes(k))) return;
                if(!playerStats.unlockedWeapons.includes(k)) return;
                let d = document.createElement('div'); d.className = 'wpn-btn'; d.setAttribute('data-wpn', k);
                d.innerText = k.substr(0,4).toUpperCase();
                d.onclick = () => { if(player) player.setWpn(k); };
                bar.appendChild(d);
            });
        }
        function updateUI() {
            if(!player) return;
            document.getElementById('grenade-counter').innerText = player.grenades;
            document.getElementById('coin-counter').innerText = playerStats.coins;
            document.getElementById('health-fill').style.width = Math.max(0, player.hp) + '%';
            document.getElementById('xp-fill').style.width = (playerStats.xp/playerStats.nextLevelXp)*100 + '%';
            document.getElementById('level-text').innerText = 'LVL ' + playerStats.level;
            if(controlMode==='MOBILE') {
                 document.querySelectorAll('.wpn-btn').forEach(b => {
                     b.className = 'wpn-btn' + (player.weapon === b.getAttribute('data-wpn') ? ' active' : '');
                 });
            }
        }

        // --- GAME LOOP ---
        function showMainMenu() {
            gameState = 'MENU'; document.getElementById('menu-overlay').style.display = 'flex';
            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('end-game-btn').style.display = 'none';
            document.getElementById('menu-buttons').style.display = 'grid';
            updateMenuStats();
        }
        function startMission(id) {
            currentMissionId = id; gameState = 'PLAYING';
            player = new Player(getW()/2, getH()/2);
            enemies=[]; bullets=[]; particles=[]; obstacles=[]; drops=[]; thrownGrenades=[];
            gameTime=0; enemiesKilled=0; grenadesKilled=0; bossSpawned=false; zoneTimer=0;
            
            if(id===9) captureZone = {x:getW()/2, y:getH()/2, radius:100};
            
            for(let i=0; i<10; i++) {
                let s = 40+Math.random()*60; let x = 50+Math.random()*(getW()-s-100); let y = 50+Math.random()*(getH()-s-100);
                if(Math.hypot(x-player.x, y-player.y)>200) obstacles.push(new Rect(x, y, s));
            }

            let t = "–ú–Ü–°–Ü–Ø";
            if(id===1) t="–í–ò–ñ–ò–¢–ò 20c"; if(id===2) t="–í–ë–ò–¢–ò 5"; if(id===3) t="–ë–û–°";
            document.getElementById('mission-text').innerText = t;
            document.getElementById('menu-overlay').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            updateUI();
        }
        function gameOver(win) {
            gameState = 'GAMEOVER'; saveGame();
            document.getElementById('menu-overlay').style.display = 'flex';
            document.getElementById('end-game-btn').style.display = 'block';
            document.getElementById('menu-buttons').style.display = 'none';
            let t = document.getElementById('menu-title');
            t.innerText = win ? "–ü–ï–†–ï–ú–û–ì–ê" : "–ü–û–†–ê–ó–ö–ê"; t.style.color = win ? "#0F0" : "red";
        }
        function spawnEnemy(forceBoss) {
             let x, y;
             if(Math.random()<0.5) { x=Math.random()<0.5?-30:getW()+30; y=Math.random()*getH(); }
             else { x=Math.random()*getW(); y=Math.random()<0.5?-30:getH()+30; }
             enemies.push(new Enemy(x, y, forceBoss?'boss':'std'));
        }

        function loop() {
            requestAnimationFrame(loop);
            if(gameState !== 'PLAYING') return;
            gameTime+=1/60;

            snowflakes.forEach(f => { f.y+=f.s; if(f.y>getH()) f.y=-10; });

            if(currentMissionId===3 && !bossSpawned && gameTime>1) { spawnEnemy(true); bossSpawned=true; }
            if(Math.floor(gameTime*60)%120===0) spawnEnemy();

            player.update();
            
            // Win conditions
            if(currentMissionId===1 && gameTime>20) gameOver(true);
            if(currentMissionId===2 && enemiesKilled>=5) gameOver(true);
            if(currentMissionId===3 && bossSpawned && !enemies.some(e=>e.type==='boss')) gameOver(true);

            let statTxt = `üïí ${gameTime.toFixed(0)}`;
            if(currentMissionId===9) {
                if(Math.hypot(player.x-captureZone.x, player.y-captureZone.y)<100) zoneTimer+=1/60;
                statTxt = `üè≥Ô∏è ${zoneTimer.toFixed(0)}/15`;
                if(zoneTimer>=15) gameOver(true);
            }
            document.getElementById('stats').innerText = statTxt;

            // Updates
            bullets.forEach((b,i) => {
                b.update();
                let hit=false;
                if(!b.isEnemy) {
                    enemies.forEach(e => {
                         if(!hit && Math.hypot(b.x-e.x, b.y-e.y) < e.radius+b.radius) { e.takeDamage(b.dmg); hit=true; }
                    });
                } else {
                     if(Math.hypot(b.x-player.x, b.y-player.y) < player.radius+b.radius) { player.hp-=b.dmg; hit=true; screenShake=5; if(player.hp<=0) gameOver(false); }
                }
                if(hit || b.dead) bullets.splice(i,1);
            });
            enemies.forEach((e,i) => { e.update(); if(e.dead) enemies.splice(i,1); });
            drops.forEach((d,i) => {
                 if(Math.hypot(d.x-player.x, d.y-player.y) < player.radius+20) {
                     if(d.type==='coin') playerStats.coins+=10; 
                     else if(d.type==='grenade') player.grenades++; 
                     else player.hp = Math.min(player.maxHp, player.hp+25);
                     drops.splice(i,1); updateUI();
                 }
            });
            thrownGrenades.forEach((g,i) => { g.update(); if(g.dead) thrownGrenades.splice(i,1); });
            particles.forEach((p,i) => { p.x+=p.vx; p.y+=p.vy; p.life--; if(p.life<=0) particles.splice(i,1); });
            
            // Draw
            if(screenShake>0.5) { ctx.save(); ctx.translate((Math.random()-0.5)*screenShake, (Math.random()-0.5)*screenShake); screenShake*=0.9; }
            ctx.fillStyle='#151520'; ctx.fillRect(0,0,getW(),getH());
            
            if(currentMissionId===9) { ctx.beginPath(); ctx.arc(captureZone.x, captureZone.y, 100, 0, Math.PI*2); ctx.fillStyle='rgba(0,100,255,0.2)'; ctx.fill(); ctx.strokeStyle='#0AF'; ctx.stroke(); }
            
            obstacles.forEach(o => o.draw());
            drops.forEach(d => d.draw());
            thrownGrenades.forEach(g => g.draw());
            particles.forEach(p => { ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,3,3); });
            bullets.forEach(b => b.draw());
            enemies.forEach(e => e.draw());
            // WH Cheat Draw
            if(activeCheats.wh) enemies.forEach(e => { 
                ctx.beginPath(); ctx.moveTo(player.x, player.y); ctx.lineTo(e.x,e.y); ctx.strokeStyle='rgba(255,0,0,0.3)'; ctx.stroke();
                ctx.strokeRect(e.x-20,e.y-20,40,40);
            });
            
            if(player.hp>0) player.draw();
            ctx.fillStyle='rgba(255,255,255,0.5)'; snowflakes.forEach(f => { ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill(); });
            
            if(screenShake>0) ctx.restore();
        }

        // --- INPUT ---
        window.addEventListener('keydown', e => keys[e.code]=true);
        window.addEventListener('keyup', e => keys[e.code]=false);
        window.addEventListener('mousemove', e => { mouse.x=e.clientX; mouse.y=e.clientY; });
        window.addEventListener('mousedown', () => mouse.down=true);
        window.addEventListener('mouseup', () => mouse.down=false);

        // Joystick logic (Multi-touch)
        const handleTouch = (e, end) => {
            if(controlMode!=='MOBILE'||gameState!=='PLAYING') return;
            // Reset logic
            let lActive=false, rActive=false;
            
            for(let i=0; i<e.touches.length; i++) {
                let t = e.touches[i];
                // Check left stick
                let stickL = document.getElementById('stick-left').getBoundingClientRect();
                let stickR = document.getElementById('stick-right').getBoundingClientRect();
                
                // Helper to process stick
                const processStick = (touch, rect, stickObj, knobId) => {
                    let cx = rect.left + rect.width/2; let cy = rect.top + rect.height/2;
                    let dx = touch.clientX - cx; let dy = touch.clientY - cy;
                    let dist = Math.min(Math.hypot(dx,dy), rect.width/2);
                    let angle = Math.atan2(dy, dx);
                    stickObj.x = Math.cos(angle)*(dist/(rect.width/2));
                    stickObj.y = Math.sin(angle)*(dist/(rect.width/2));
                    stickObj.active = true;
                    document.getElementById(knobId).style.transform = `translate(-50%, -50%) translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
                };

                // Simple hitbox check
                if(Math.hypot(t.clientX - (stickL.left+stickL.width/2), t.clientY - (stickL.top+stickL.height/2)) < 100) {
                    processStick(t, stickL, joystickLeft, 'knob-left'); lActive=true;
                }
                if(Math.hypot(t.clientX - (stickR.left+stickR.width/2), t.clientY - (stickR.top+stickR.height/2)) < 100) {
                    processStick(t, stickR, joystickRight, 'knob-right'); rActive=true;
                }
            }
            
            if(!lActive && end) { joystickLeft.active=false; joystickLeft.x=0; joystickLeft.y=0; document.getElementById('knob-left').style.transform='translate(-50%,-50%)'; }
            if(!rActive && end) { joystickRight.active=false; joystickRight.x=0; joystickRight.y=0; document.getElementById('knob-right').style.transform='translate(-50%,-50%)'; }
        };

        document.addEventListener('touchstart', e => handleTouch(e, false), {passive:false});
        document.addEventListener('touchmove', e => { e.preventDefault(); handleTouch(e, false); }, {passive:false});
        document.addEventListener('touchend', e => handleTouch(e, true));
        
        function throwGrenadeMobile() { if(player) player.throwG(player.x+Math.cos(lastAimAngle)*200, player.y+Math.sin(lastAimAngle)*200); }

        loop();
    </script>
</body>
</html>
