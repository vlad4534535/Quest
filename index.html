<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Shooter: Compact Mobile</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a2e;
            font-family: 'Courier New', Courier, monospace;
            color: white;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        canvas { display: block; }
        
        /* UI */
        #game-ui {
            display: none;
            position: absolute;
            top: 5px; left: 5px;
            pointer-events: none;
            width: 100%;
            box-sizing: border-box;
            padding-right: 10px;
            z-index: 5;
        }
        #top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .stat-box {
            background: rgba(0,0,0,0.6);
            padding: 3px 6px;
            border-radius: 4px;
            margin-bottom: 3px;
            font-size: 12px; /* –ú–µ–Ω—à–∏–π —à—Ä–∏—Ñ—Ç —Å—Ç–∞—Ç—ñ–≤ */
            border: 1px solid rgba(255,255,255,0.2);
        }
        #mission-text {
            font-size: 16px; font-weight: bold; color: #77DDFF;
            text-shadow: 1px 1px 0 #000;
        }
        #weapon-info { color: #aaa; font-size: 10px; }
        #grenade-counter { color: #FFA500; font-weight: bold; }
        #coin-counter { color: #FFFF00; font-weight: bold; }
        
        /* HP & XP BARS */
        .bar-container {
            margin-top: 3px; width: 120px; height: 10px; /* –ú–µ–Ω—à—ñ —Å–º—É–∂–∫–∏ */
            background: #444; border: 1px solid #fff;
            position: relative;
        }
        #health-fill {
            width: 100%; height: 100%;
            background: #00FF00; transition: width 0.1s;
        }
        #xp-bar-container {
            margin-top: 3px; height: 6px; border-color: #0077FF;
        }
        #xp-fill {
            width: 0%; height: 100%;
            background: #0077FF; transition: width 0.2s;
        }
        #level-text {
            position: absolute; top: -15px; left: 0;
            font-size: 10px; color: #0077FF; font-weight: bold;
        }

        /* –ú–ï–ù–Æ */
        .overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(10, 20, 40, 0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; 
            z-index: 20;
        }
        h1 { margin-bottom: 5px; font-size: 24px; color: #00AAFF; text-align: center; text-transform: uppercase; text-shadow: 0 0 10px white; }
        h2 { margin-bottom: 10px; font-size: 14px; color: #aaa; }
        .menu-stats { color: #FFFF00; margin-bottom: 10px; font-size: 12px; border: 1px solid #555; padding: 5px; text-align: center; }
        
        .mission-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px;
            max-height: 55vh; overflow-y: auto; width: 90%;
        }

        .btn {
            background: #222; color: white;
            border: 1px solid #0077FF; padding: 8px;
            font-size: 11px; cursor: pointer; width: 100%;
            text-align: center; font-family: inherit; margin: 0;
        }
        .btn:hover { background: #0077FF; color: black; }
        .boss-btn { border-color: #A020F0; color: #E0E0E0; }
        .hard-btn { border-color: #FF3333; color: #FFAAAA; }
        .special-btn { border-color: #00FFCC; color: #AAFFFF; }
        .shop-btn { border-color: #FFFF00; color: #FFFFAA; width: 250px; margin-top: 10px; font-size: 14px; font-weight: bold;}

        /* --- –ú–ê–ì–ê–ó–ò–ù (–ö–û–ú–ü–ê–ö–¢–ù–ò–ô) --- */
        #shop-screen { display: none; padding-top: 10px; }
        .shop-container {
            display: flex; gap: 5px; width: 98%; justify-content: center; flex-wrap: wrap;
            align-items: flex-start;
            padding-bottom: 40px;
            overflow-y: auto;
        }
        /* –ö–æ–ª–æ–Ω–∫–∏ —Ç–µ–ø–µ—Ä –º–∞–ª–µ–Ω—å–∫—ñ, –ø–æ 47% —à–∏—Ä–∏–Ω–∏, —â–æ–± –±—É–ª–æ 2 –≤ —Ä—è–¥ */
        .shop-column {
            background: #223; padding: 5px; border: 1px solid #558; width: 46%; 
            box-sizing: border-box; border-radius: 5px;
        }
        .shop-column h3 {
            font-size: 12px; margin: 5px 0; text-align: center; color: #ccc;
        }
        .shop-item {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 3px;
        }
        .shop-item span {
            font-size: 10px; /* –î—É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–π —Ç–µ–∫—Å—Ç */
            max-width: 60px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
        }
        .buy-btn {
            background: #222; border: 1px solid #FFFF00; color: #FFFF00; padding: 2px 5px; cursor: pointer; font-size: 9px;
            min-width: 40px;
        }
        .buy-btn.owned { background: #004400; border-color: #00FF00; color: white; cursor: default; }
        .buy-btn.equipped { background: #00FF00; color: black; font-weight: bold; }
        .buy-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: #555; color: #555; }
        
        .preview-area {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 5px; width: 94% !important; /* –ü—Ä–µ–≤'—é –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
        }

        /* –ü–†–û–ú–û–ö–û–î–ò */
        .promo-container {
            margin-top: 10px; padding: 5px; border-top: 1px dashed #555; width: 100%; text-align: center;
        }
        #promo-input {
            background: #111; border: 1px solid #0077FF; color: white; padding: 3px; width: 80px; font-size: 10px; text-transform: uppercase;
        }
        #promo-btn {
            background: #0077FF; color: white; border: none; padding: 3px 6px; cursor: pointer; font-size: 10px; margin-left: 2px;
        }

        /* CHEAT UI */
        #santa-cheat-btn {
            display: none;
            position: absolute; top: 5px; right: 5px;
            width: 40px; height: 40px;
            background: white; border-radius: 50%;
            text-align: center; line-height: 40px; font-size: 24px;
            cursor: pointer; z-index: 1000;
            box-shadow: 0 0 10px cyan;
            pointer-events: auto;
            user-select: none;
        }
        #cheat-menu {
            display: none;
            position: absolute; top: 50px; right: 5px;
            background: rgba(0,0,0,0.9); border: 2px solid white;
            padding: 10px; width: 150px; z-index: 999;
            pointer-events: auto;
            border-radius: 8px;
        }
        .cheat-option {
            margin-bottom: 10px; font-size: 12px; color: #00FF00; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* –ú–û–ë–Ü–õ–¨–ù–ï –ö–ï–†–£–í–ê–ù–ù–Ø (–ú–ê–õ–ï–ù–¨–ö–ï) */
        #mobile-controls {
            display: none; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; pointer-events: none; z-index: 10;
        }
        .joystick-zone {
            position: absolute; bottom: 20px;
            width: 80px; height: 80px; /* –©–µ –º–µ–Ω—à–µ */
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%; pointer-events: auto;
        }
        #stick-left { left: 15px; }
        #stick-right { right: 15px; }
        
        .joystick-knob {
            position: absolute; top: 50%; left: 50%;
            width: 30px; height: 30px;
            background: rgba(0, 119, 255, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none;
        }
        #stick-right .joystick-knob { background: rgba(255, 51, 51, 0.5); }
        
        #mobile-grenade-btn {
            position: absolute; bottom: 80px; right: 110px;
            width: 40px; height: 40px;
            background: rgba(255, 165, 0, 0.3); border: 2px solid #FFA500;
            border-radius: 50%; color: #FFA500; font-size: 18px;
            display: flex; justify-content: center; align-items: center;
            pointer-events: auto; cursor: pointer;
        }
        
        #weapon-bar {
            position: absolute; bottom: 10px; left: 50%;
            transform: translateX(-50%); display: flex; gap: 4px; pointer-events: auto;
        }
        .wpn-btn {
            width: 32px; height: 32px;
            background: #333; border: 1px solid #666;
            color: white; font-size: 8px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            border-radius: 4px; font-family: inherit; cursor: pointer;
        }
        .wpn-btn.active { border-color: #0077FF; background: #004488; }
        .wpn-btn.locked { opacity: 0.3; border-color: #333; cursor: not-allowed; }
        
        #levelup-notify {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
            font-size: 30px; color: #FFD700; font-weight: bold; text-shadow: 0 0 10px orange;
            pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 100;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="santa-cheat-btn">üéÖ</div>
    <div id="cheat-menu">
        <div class="cheat-option"><label>AIMBOT</label><input type="checkbox" id="chk-aim" onchange="toggleCheat('aim')"></div>
        <div class="cheat-option"><label>WH (ESP)</label><input type="checkbox" id="chk-wh" onchange="toggleCheat('wh')"></div>
        <div class="cheat-option"><label>AUTO LOOT</label><input type="checkbox" id="chk-autoloot" onchange="toggleCheat('autoloot')"></div>
        <div class="cheat-option"><label>WALLBANG</label><input type="checkbox" id="chk-wallbang" onchange="toggleCheat('wallbang')"></div>
    </div>

    <div id="platform-screen" class="overlay" style="z-index: 30;">
        <h1>Tactical Shooter<br>‚ùÑÔ∏è New Year ‚ùÑÔ∏è</h1>
        <h2>–û–±–µ—Ä—ñ—Ç—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è</h2>
        <button class="btn" onclick="selectPlatform('PC')">üíª –ü–ö</button>
        <button class="btn" onclick="selectPlatform('MOBILE')">üì± –¢–µ–ª–µ—Ñ–æ–Ω</button>
    </div>

    <div id="shop-screen" class="overlay" style="z-index: 25; display: none;">
        <h1 style="font-size: 20px;">–ú–ê–ì–ê–ó–ò–ù</h1>
        <div style="color: yellow; margin-bottom: 5px; font-size: 14px;">üí∞: <span id="shop-coins">0</span> | LVL: <span id="shop-level">1</span></div>
        
        <div class="shop-container">
            <div class="shop-column preview-area">
                <h3>–ó–û–í–ù–Ü–®–ù–Ü–°–¢–¨</h3>
                <canvas id="previewCanvas" width="100" height="100" style="border: 1px solid #555; background: #222; margin-bottom: 5px;"></canvas>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label style="font-size: 10px;">–ö–æ–ª—ñ—Ä:</label>
                    <input type="color" id="colorPicker" value="#0077FF" style="width: 30px; height: 20px; border:none;" onchange="updatePreview()">
                </div>
            </div>

            <div class="shop-column">
                <h3>–û–î–Ø–ì</h3>
                <div id="accessories-list"></div>
            </div>

            <div class="shop-column">
                <h3>–ó–ë–†–û–Ø</h3>
                <div id="weapons-list"></div>
                
                <div class="promo-container">
                    <div style="font-size:9px; color:#aaa; margin-bottom:2px;">–ü–†–û–ú–û–ö–û–î:</div>
                    <input type="text" id="promo-input" placeholder="–ö–û–î">
                    <button id="promo-btn" onclick="redeemCode()">OK</button>
                </div>
            </div>
        </div>

        <button class="btn" onclick="closeShop()" style="margin-top: 10px; width: 200px; background: #444;">–ó–ë–ï–†–ï–ì–¢–ò –Ü –í–ò–ô–¢–ò</button>
    </div>

    <div id="menu-overlay" class="overlay" style="display: none;">
        <h1 id="menu-title">–ú–Ü–°–Ü–á</h1>
        <div class="menu-stats">
            LVL: <span id="menu-level">1</span> | XP: <span id="menu-xp">0</span><br>
            –í–ë–ò–í–°–¢–í: <span id="menu-kills">0</span> | –ú–û–ù–ï–¢: <span id="menu-coins">0</span>
        </div>
        
        <div id="menu-buttons" class="mission-grid">
            <button class="btn" onclick="startMission(1)">1: –û–∫–æ–ø (20—Å)</button>
            <button class="btn" onclick="startMission(2)">2: –ó–∞—á–∏—Å—Ç–∫–∞ (5)</button>
            <button class="btn boss-btn" onclick="startMission(3)">3: –ë–û–°</button>
            <button class="btn" onclick="startMission(4)">4: –û–†–î–ê (40—Å)</button>
            <button class="btn" onclick="startMission(5)">5: –ú'–Ø–°–û (50)</button>
            <button class="btn hard-btn" onclick="startMission(6)">6: –•–ê–†–î (60—Å)</button>
            <button class="btn grenade-mission-btn" onclick="startMission(7)">7: –ü–Ü–î–†–ò–í (15)</button>
            <button class="btn hard-btn" onclick="startMission(8)">8: –ê–ü–û–ö–ê–õ–Ü–ü–°–ò–°</button>
            <button class="btn special-btn" onclick="startMission(9)">9: –ó–ê–•–í–ê–¢</button>
            <button class="btn special-btn" onclick="startMission(10)">10: –¢–ï–ú–†–Ø–í–ê</button>
            <button class="btn special-btn" onclick="startMission(11)">11: –°–ù–ê–ô–ü–ï–†</button>
        </div>
        <button class="btn shop-btn" onclick="openShop()">üõí –ú–ê–ì–ê–ó–ò–ù</button>
        <button id="end-game-btn" class="btn" onclick="showMainMenu()" style="display:none; background: #FF3333; margin-top: 10px;">–ú–ï–ù–Æ</button>
    </div>

    <div id="game-ui">
        <div id="top-bar">
            <div>
                <div id="mission-text">–¶—ñ–ª—å: ...</div>
                <div class="bar-container" id="health-bar"><div id="health-fill"></div></div>
                <div class="bar-container" id="xp-bar-container">
                    <div id="level-text">LVL 1</div>
                    <div id="xp-fill"></div>
                </div>
                <div class="stat-box" id="weapon-info" style="margin-top: 3px;">–ó–±—Ä–æ—è: ...</div>
            </div>
            <div style="text-align: right;">
                <div class="stat-box" id="stats">–ß–∞—Å: 0</div>
                <div class="stat-box" id="grenade-counter">üí£: 3</div>
                <div class="stat-box" id="coin-counter">üí∞: 0</div>
            </div>
        </div>
    </div>
    
    <div id="levelup-notify">LEVEL UP!</div>

    <div id="mobile-controls">
        <div id="stick-left" class="joystick-zone"><div class="joystick-knob" id="knob-left"></div></div>
        <div id="stick-right" class="joystick-zone"><div class="joystick-knob" id="knob-right"></div></div>
        <div id="mobile-grenade-btn" onclick="throwGrenadeMobile()">üí£</div>
        <div id="weapon-bar"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        let playerStats = {
            totalKills: 0, coins: 0, color: '#0077FF', xp: 0, level: 1, nextLevelXp: 100,
            unlockedWeapons: ['pistol', 'rifle', 'shotgun', 'sniper'],
            unlockedOutfits: ['none'], currentOutfit: 'none', redeemedCodes: [], cheatsUnlocked: false 
        };
        
        let activeCheats = { aim: false, wh: false, autoloot: false, wallbang: false };

        function toggleCheatMenu() {
            let menu = document.getElementById('cheat-menu');
            let btn = document.getElementById('santa-cheat-btn');
            if (menu.style.display !== 'block') {
                const rect = btn.getBoundingClientRect();
                menu.style.top = (rect.bottom + 5) + 'px';
                let leftPos = rect.left - (menu.offsetWidth - rect.width)/2;
                if(leftPos + 150 > window.innerWidth) leftPos = window.innerWidth - 160;
                menu.style.left = leftPos + 'px';
            }
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function toggleCheat(type) {
            if (type === 'aim') activeCheats.aim = document.getElementById('chk-aim').checked;
            if (type === 'wh') activeCheats.wh = document.getElementById('chk-wh').checked;
            if (type === 'autoloot') activeCheats.autoloot = document.getElementById('chk-autoloot').checked;
            if (type === 'wallbang') activeCheats.wallbang = document.getElementById('chk-wallbang').checked;
        }

        const santaBtn = document.getElementById('santa-cheat-btn');
        let dragObj = null; let dragOffsetX = 0; let dragOffsetY = 0; let isDraggingCheat = false;

        const startDrag = (clientX, clientY) => {
            isDraggingCheat = false; dragObj = santaBtn;
            const rect = santaBtn.getBoundingClientRect();
            dragOffsetX = clientX - rect.left; dragOffsetY = clientY - rect.top;
        };

        santaBtn.addEventListener('mousedown', (e) => { if(e.button===0) startDrag(e.clientX, e.clientY); });
        santaBtn.addEventListener('touchstart', (e) => { startDrag(e.touches[0].clientX, e.touches[0].clientY); e.preventDefault(); }, {passive: false});

        const moveDrag = (clientX, clientY) => {
            if (dragObj) {
                isDraggingCheat = true;
                let newLeft = clientX - dragOffsetX; let newTop = clientY - dragOffsetY;
                newLeft = Math.max(0, Math.min(window.innerWidth - dragObj.offsetWidth, newLeft));
                newTop = Math.max(0, Math.min(window.innerHeight - dragObj.offsetHeight, newTop));
                dragObj.style.left = newLeft + 'px'; dragObj.style.top = newTop + 'px';
                document.getElementById('cheat-menu').style.display = 'none';
            }
        };

        window.addEventListener('mousemove', (e) => moveDrag(e.clientX, e.clientY));
        window.addEventListener('touchmove', (e) => moveDrag(e.touches[0].clientX, e.touches[0].clientY));
        window.addEventListener('mouseup', () => { if (dragObj && !isDraggingCheat) toggleCheatMenu(); dragObj = null; });
        window.addEventListener('touchend', () => { if (dragObj && !isDraggingCheat) toggleCheatMenu(); dragObj = null; });

        function getNextLevelXp(lvl) { return Math.floor(100 * Math.pow(1.2, lvl - 1)); }
        function addPlayerXp(amount) {
            playerStats.xp += amount;
            if (playerStats.xp >= playerStats.nextLevelXp) levelUp();
            updateUI();
        }
        function levelUp() {
            playerStats.xp -= playerStats.nextLevelXp; playerStats.level++;
            playerStats.nextLevelXp = getNextLevelXp(playerStats.level);
            playerStats.coins += 50 * playerStats.level;
            if (player) player.hp = player.maxHp;
            showLevelUpEffect(); saveGame();
            if (playerStats.xp >= playerStats.nextLevelXp) levelUp();
        }
        function showLevelUpEffect() {
            const el = document.getElementById('levelup-notify');
            el.style.opacity = 1; el.style.top = '40%';
            setTimeout(() => { el.style.opacity = 0; el.style.top = '30%'; }, 2000);
        }

        function loadGame() {
            let saved = localStorage.getItem('tacticalShooterData_v2');
            if (saved) {
                let parsed = JSON.parse(saved);
                playerStats = { ...playerStats, ...parsed };
                playerStats.nextLevelXp = getNextLevelXp(playerStats.level);
                if(!playerStats.redeemedCodes) playerStats.redeemedCodes = [];
                if(playerStats.cheatsUnlocked) document.getElementById('santa-cheat-btn').style.display = 'block';
            }
            updateMenuStats();
        }
        function saveGame() { localStorage.setItem('tacticalShooterData_v2', JSON.stringify(playerStats)); updateMenuStats(); }
        function updateMenuStats() {
            document.getElementById('menu-kills').innerText = playerStats.totalKills;
            document.getElementById('menu-coins').innerText = playerStats.coins;
            document.getElementById('menu-level').innerText = playerStats.level;
            document.getElementById('menu-xp').innerText = `${Math.floor(playerStats.xp)}/${playerStats.nextLevelXp}`;
        }

        const shopItems = {
            outfits: [
                { id: 'none', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', price: 0 },
                { id: 'santa_hat', name: '–®–∞–ø–∫–∞', price: 0 },
                { id: 'cap', name: '–ö–µ–ø–∫–∞', price: 150 },
                { id: 'helmet', name: '–ö–∞—Å–∫–∞', price: 300 },
                { id: 'vest', name: '–ñ–∏–ª–µ—Ç', price: 500 }
            ],
            weapons: [
                { id: 'minigun', name: '–ö–£–õ–ï–ú–ï–¢', price: 1000, levelReq: 5 }
            ]
        };

        const previewCanvas = document.getElementById('previewCanvas');
        const pCtx = previewCanvas.getContext('2d');

        function openShop() {
            document.getElementById('menu-overlay').style.display = 'none';
            document.getElementById('shop-screen').style.display = 'flex'; // Flex for columns
            document.getElementById('shop-coins').innerText = playerStats.coins;
            document.getElementById('shop-level').innerText = playerStats.level;
            renderShopItems();
            updatePreview();
        }
        function closeShop() {
            saveGame();
            document.getElementById('shop-screen').style.display = 'none';
            document.getElementById('menu-overlay').style.display = 'flex';
        }

        function renderShopItems() {
            const accList = document.getElementById('accessories-list'); accList.innerHTML = '';
            shopItems.outfits.forEach(item => {
                let div = document.createElement('div'); div.className = 'shop-item';
                let owned = playerStats.unlockedOutfits.includes(item.id);
                let equipped = playerStats.currentOutfit === item.id;
                let btnText = owned ? (equipped ? '‚úì' : '–û–¥—è–≥—Ç–∏') : `${item.price}$`;
                let btnClass = equipped ? 'buy-btn equipped' : (owned ? 'buy-btn owned' : 'buy-btn');
                div.innerHTML = `<span>${item.name}</span> <button class="${btnClass}" onclick="handleShopAction('outfit', '${item.id}', ${item.price})">${btnText}</button>`;
                accList.appendChild(div);
            });

            const wpnList = document.getElementById('weapons-list'); wpnList.innerHTML = '';
            shopItems.weapons.forEach(item => {
                let div = document.createElement('div'); div.className = 'shop-item';
                let owned = playerStats.unlockedWeapons.includes(item.id);
                let lockedLevel = item.levelReq && playerStats.level < item.levelReq;
                let btnText = owned ? '–ö—É–ø–ª–µ–Ω–æ' : (lockedLevel ? `LVL${item.levelReq}` : `${item.price}$`);
                let btnClass = owned ? 'buy-btn owned' : 'buy-btn';
                div.innerHTML = `<span>${item.name}</span> <button class="${btnClass}" onclick="handleShopAction('weapon', '${item.id}', ${item.price})" ${owned||lockedLevel?'disabled':''}>${btnText}</button>`;
                wpnList.appendChild(div);
            });
        }

        function handleShopAction(type, id, price) {
            if (type === 'outfit') {
                if (playerStats.unlockedOutfits.includes(id)) playerStats.currentOutfit = id;
                else if (playerStats.coins >= price) {
                    playerStats.coins -= price; playerStats.unlockedOutfits.push(id); playerStats.currentOutfit = id;
                }
            } else if (type === 'weapon') {
                if (!playerStats.unlockedWeapons.includes(id) && playerStats.coins >= price) {
                    playerStats.coins -= price; playerStats.unlockedWeapons.push(id);
                }
            }
            updatePreview(); renderShopItems(); document.getElementById('shop-coins').innerText = playerStats.coins;
        }

        function updatePreview() {
            let color = document.getElementById('colorPicker').value; playerStats.color = color;
            // –û–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è Canvas 100x100
            pCtx.clearRect(0,0,100,100); pCtx.save();
            pCtx.translate(50, 50); pCtx.scale(2.2, 2.2); // –ú–µ–Ω—à–∏–π –º–∞—Å—à—Ç–∞–±
            
            pCtx.beginPath(); pCtx.arc(0, 0, 15, 0, Math.PI * 2); pCtx.fillStyle = color; pCtx.fill();
            pCtx.strokeStyle = '#000'; pCtx.lineWidth = 1; pCtx.stroke();

            if (playerStats.currentOutfit === 'santa_hat') {
                pCtx.fillStyle = '#D40000'; pCtx.beginPath(); pCtx.moveTo(-15, -5); pCtx.lineTo(15, -5); pCtx.lineTo(0, -28); pCtx.fill();
                pCtx.fillStyle = '#FFFFFF'; pCtx.fillRect(-16, -5, 32, 6); pCtx.beginPath(); pCtx.arc(0, -28, 5, 0, Math.PI*2); pCtx.fill();
            } else if (playerStats.currentOutfit === 'helmet') {
                pCtx.fillStyle = '#334400'; pCtx.beginPath(); pCtx.arc(0, 0, 16, Math.PI, 0); pCtx.fill();
                pCtx.fillStyle = '#223300'; pCtx.fillRect(-15, -5, 30, 5);
            } else if (playerStats.currentOutfit === 'vest') {
                 pCtx.fillStyle = '#2E3B22'; pCtx.fillRect(-14, -14, 28, 28);
                 pCtx.fillStyle = '#4A5D3A'; pCtx.fillRect(-10, 2, 8, 10); pCtx.fillRect(2, 2, 8, 10);
            } else if (playerStats.currentOutfit === 'cap') {
                pCtx.fillStyle = '#C2B280'; pCtx.beginPath(); pCtx.arc(0, 0, 15, Math.PI * 0.8, Math.PI * 3.2); pCtx.fill();
                pCtx.fillStyle = '#A09165'; pCtx.fillRect(13, -13, 14, 26);
            }
            pCtx.fillStyle = '#000'; pCtx.fillRect(10, -3, 15, 6); pCtx.restore();
        }

        function redeemCode() {
            const input = document.getElementById('promo-input'); const code = input.value.trim().toUpperCase(); 
            const secretCode = "FHJWIDFNN2137217^$&*@JFUHIWHAAHSDN2273871287873201JDFJHWOMF%(#&$(*@&";
            if (playerStats.redeemedCodes.includes(code)) { alert("–í–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ!"); return; }
            let s = false; let m = "";
            if (code === secretCode) { playerStats.cheatsUnlocked = true; document.getElementById('santa-cheat-btn').style.display = 'block'; m = "–°–ï–ö–†–ï–¢!"; s = true; }
            if (code === 'XST46GYS73') { playerStats.coins += 500; m = "+500$"; s = true; }
            if (code === 'NEWYEAR2026' && !playerStats.unlockedWeapons.includes('snowball')) { playerStats.unlockedWeapons.push('snowball'); m = "–°–Ω—ñ–≥–æ–º–µ—Ç!"; s = true; }
            if (code === 'DAVX5H8KD') { playerStats.coins += 1000; if(playerStats.level<5) playerStats.level=5; if(!playerStats.unlockedWeapons.includes('minigun')) playerStats.unlockedWeapons.push('minigun'); m = "–ë–û–ù–£–°!"; s = true; }
            
            if (s) { playerStats.redeemedCodes.push(code); saveGame(); updateMenuStats(); document.getElementById('shop-coins').innerText = playerStats.coins; renderShopItems(); alert(m); input.value = ""; }
            else if(code!==secretCode) alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –∫–æ–¥!");
        }

        const PLAYER_SPEED = 4.5; const BULLET_SPEED = 14; const ENEMY_SPEED = 2.5; 
        let controlMode = 'PC'; let gameState = 'PLATFORM_SELECT'; let currentMissionId = 0;
        let gameTime = 0; let enemiesKilled = 0; let grenadesKilled = 0; let bossSpawned = false;
        let zoneTimer = 0; let captureZone = { x: 0, y: 0, radius: 100 }; let screenShake = 0;
        let obstacles = [], bullets = [], enemies = [], particles = [], drops = [], thrownGrenades = [], decorations = [], snowflakes = [];
        let player; let keys = {}; let mouse = { x: 0, y: 0, down: false };
        let joystickLeft = { x: 0, y: 0, active: false, id: null };
        let joystickRight = { x: 0, y: 0, active: false, id: null };
        let lastAimAngle = 0;

        for(let i=0; i<60; i++) snowflakes.push({x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, r: Math.random()*2+0.5, s: Math.random()*1+0.2});

        class DropItem {
            constructor(x, y, type) { this.x = x; this.y = y; this.type = type; this.size = 20; this.bobOffset = Math.random() * Math.PI * 2; }
            draw() {
                let Y = this.y + Math.sin(gameTime * 5 + this.bobOffset) * 3;
                if (this.type === 'medkit') { ctx.fillStyle = '#0C0'; ctx.fillRect(this.x-10, Y-10, 20, 20); ctx.fillStyle = '#FFF'; ctx.fillRect(this.x-3, Y-8, 6, 16); ctx.fillRect(this.x-8, Y-3, 16, 6); }
                else if (this.type === 'grenade') { ctx.fillStyle = '#F80'; ctx.beginPath(); ctx.arc(this.x, Y, 10, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='#000'; ctx.fillText("üí£", this.x-6, Y+5); }
                else { ctx.fillStyle = '#FF0'; ctx.beginPath(); ctx.arc(this.x, Y, 10, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='black'; ctx.fillText("$", this.x-4, Y+5); }
            }
        }
        class GrenadeObj {
            constructor(x, y, tx, ty) { this.x=x; this.y=y; this.timer=60; this.dead=false; let a=Math.atan2(ty-y,tx-x); let d=Math.hypot(tx-x,ty-y); let s=Math.min(d/20,10); this.vx=Math.cos(a)*s; this.vy=Math.sin(a)*s; this.fly=Math.floor(d/s); }
            update() { if(this.fly>0){this.x+=this.vx;this.y+=this.vy;this.fly--;} this.timer--; if(this.timer<=0){this.explode();this.dead=true;} }
            explode() { createExplosion(this.x, this.y); screenShake=15; enemies.forEach(e=>{if(Math.hypot(e.x-this.x,e.y-this.y)<120){e.takeDamage(150);if(e.hp<=0)grenadesKilled++;}}); }
            draw() { ctx.beginPath(); ctx.arc(this.x,this.y,6,0,Math.PI*2); ctx.fillStyle=Math.floor(this.timer/5)%2===0?'red':'yellow'; ctx.fill(); }
        }
        class Rect {
            constructor(x, y, size) { this.x = x; this.y = y; this.size = size; }
            draw() { ctx.fillStyle='#556'; ctx.fillRect(this.x,this.y,this.size,this.size); ctx.fillStyle='#EEF'; ctx.beginPath(); ctx.moveTo(this.x-2,this.y); ctx.lineTo(this.x+this.size+2,this.y); ctx.lineTo(this.x+this.size+2,this.y+15); for(let i=0;i<this.size;i+=10)ctx.arc(this.x+this.size-i,this.y+15,5,0,Math.PI); ctx.lineTo(this.x-2,this.y+15); ctx.fill(); }
        }
        class Entity {
            constructor(x, y, r, c, hp) { this.x=x; this.y=y; this.radius=r; this.color=c; this.hp=hp; this.maxHp=hp; this.dead=false; this.cooldown=0; }
            drawBase() { ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2); ctx.fillStyle=this.color; ctx.fill(); ctx.stroke(); }
            drawHealthBar() { if(this.hp<this.maxHp){ let w=this.radius*2; ctx.fillStyle='red'; ctx.fillRect(this.x-w/2,this.y-this.radius-8,w,4); ctx.fillStyle='#0F0'; ctx.fillRect(this.x-w/2,this.y-this.radius-8,w*(this.hp/this.maxHp),4); } }
            move(dx, dy) { if(!this.check(this.x+dx,this.y))this.x+=dx; if(!this.check(this.x,this.y+dy))this.y+=dy; this.x=Math.max(this.radius,Math.min(canvas.width-this.radius,this.x)); this.y=Math.max(this.radius,Math.min(canvas.height-this.radius,this.y)); }
            check(x, y) { for(let o of obstacles){ let cx=Math.max(o.x,Math.min(x,o.x+o.size)); let cy=Math.max(o.y,Math.min(y,o.y+o.size)); if((x-cx)**2+(y-cy)**2<this.radius**2)return true; } return false; }
        }
        class Player extends Entity {
            constructor(x, y) { super(x, y, 15, playerStats.color, 100); this.weapon='pistol'; this.grenades=3; this.angle=0; }
            draw() {
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fillStyle = playerStats.color; ctx.fill(); ctx.stroke();
                if(playerStats.currentOutfit==='santa_hat'){ ctx.fillStyle='#D00'; ctx.beginPath(); ctx.moveTo(-15,-5); ctx.lineTo(15,-5); ctx.lineTo(0,-28); ctx.fill(); ctx.fillStyle='#FFF'; ctx.fillRect(-16,-5,32,6); ctx.beginPath(); ctx.arc(0,-28,5,0,Math.PI*2); ctx.fill(); }
                else if(playerStats.currentOutfit==='helmet'){ ctx.fillStyle='#340'; ctx.beginPath(); ctx.arc(0,0,16,Math.PI,0); ctx.fill(); ctx.fillRect(-15,-5,30,5); }
                else if(playerStats.currentOutfit==='vest'){ ctx.fillStyle='#232'; ctx.fillRect(-14,-14,28,28); }
                else if(playerStats.currentOutfit==='cap'){ ctx.fillStyle='#CB8'; ctx.beginPath(); ctx.arc(0,0,15,Math.PI*0.8,Math.PI*3.2); ctx.fill(); ctx.fillStyle='#A96'; ctx.fillRect(13,-13,14,26); }
                ctx.fillStyle = this.weapon==='snowball'?'#0FF':'#000'; ctx.fillRect(10, -3, 15, 6);
                ctx.restore();
            }
            update() {
                if(this.cooldown>0)this.cooldown--;
                let dx=0, dy=0;
                if(activeCheats.aim && enemies.length>0) { let cl=enemies.reduce((a,b)=>Math.hypot(a.x-this.x,a.y-this.y)<Math.hypot(b.x-this.x,b.y-this.y)?a:b); this.angle=Math.atan2(cl.y-this.y,cl.x-this.x); lastAimAngle=this.angle; }
                if(activeCheats.autoloot && drops.length>0){ this.x=drops[0].x; this.y=drops[0].y; }
                if(controlMode==='PC') {
                    if(keys['Digit1'])this.trySetWeapon('pistol'); if(keys['Digit2'])this.trySetWeapon('rifle'); if(keys['Digit3'])this.trySetWeapon('shotgun');
                    if(keys['KeyW'])dy=-PLAYER_SPEED; if(keys['KeyS'])dy=PLAYER_SPEED; if(keys['KeyA'])dx=-PLAYER_SPEED; if(keys['KeyD'])dx=PLAYER_SPEED;
                    if(dx&&dy){dx*=0.707;dy*=0.707;} if(!activeCheats.aim)this.angle=Math.atan2(mouse.y-this.y,mouse.x-this.x);
                    if(keys['Space'] && this.grenades>0) { this.grenades--; thrownGrenades.push(new GrenadeObj(this.x,this.y,mouse.x,mouse.y)); keys['Space']=false; updateUI(); }
                    if(mouse.down)this.shoot(this.angle);
                } else {
                    if(joystickLeft.active){dx=joystickLeft.x*PLAYER_SPEED;dy=joystickLeft.y*PLAYER_SPEED;}
                    if(joystickRight.active){ if(!activeCheats.aim)this.angle=Math.atan2(joystickRight.y,joystickRight.x); this.shoot(this.angle); lastAimAngle=this.angle;}
                    else if((dx||dy)&&!activeCheats.aim)this.angle=Math.atan2(dy,dx);
                }
                this.move(dx, dy);
            }
            trySetWeapon(w) { if((w==='minigun'&&playerStats.level<5)||!playerStats.unlockedWeapons.includes(w))return; this.weapon=w; updateUI(); }
            throwGrenade(tx, ty) { if(this.grenades>0){ this.grenades--; thrownGrenades.push(new GrenadeObj(this.x,this.y,tx,ty)); updateUI(); } }
            shoot(a) {
                if(this.cooldown>0)return;
                if(this.weapon==='shotgun'||this.weapon==='sniper')screenShake=5;
                if(this.weapon==='pistol')this.b(a,0,20,20);
                else if(this.weapon==='rifle')this.b(a,(Math.random()-0.5)*0.2,10,6);
                else if(this.weapon==='shotgun'){this.b(a,0,15,45);this.b(a+0.15,0,15,45);this.b(a-0.15,0,15,45);}
                else if(this.weapon==='sniper')this.b(a,0,100,60,25);
                else if(this.weapon==='minigun'){this.b(a,(Math.random()-0.5)*0.4,8,3);screenShake=2;}
                else if(this.weapon==='snowball')this.b(a,0,10000,30,10,'snowball');
            }
            b(a,spr,dmg,cd,spd=BULLET_SPEED,t='normal'){ bullets.push(new Bullet(this.x,this.y,{x:Math.cos(a+spr)*spd,y:Math.sin(a+spr)*spd},false,dmg,t==='snowball'?8:4,t)); this.cooldown=cd; }
        }
        class Enemy extends Entity {
            constructor(x, y, type) {
                let r=15,h=40,c='#F33',s=ENEMY_SPEED; if(type==='boss'){r=40;h=600;c='#A0F';s=1.5;}
                if(currentMissionId===6)s*=1.4; if(currentMissionId===8)s*=1.2;
                super(x, y, r, c, h); this.type=type; this.speed=s;
            }
            draw(){
                let a=0; if(player)a=Math.atan2(player.y-this.y,player.x-this.x);
                ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(a);
                super.drawBase(); ctx.fillStyle=this.type==='boss'?'#404':'#500'; ctx.fillRect(this.radius-2,-3,this.type==='boss'?25:15,6);
                ctx.restore(); this.drawHealthBar();
            }
            update() {
                if(this.cooldown>0)this.cooldown--;
                let d=Math.hypot(player.x-this.x,player.y-this.y); let a=Math.atan2(player.y-this.y,player.x-this.x);
                if(d>150+this.radius)this.move(Math.cos(a)*this.speed,Math.sin(a)*this.speed);
                else if(d<100)this.move(-Math.cos(a)*this.speed*0.5,-Math.sin(a)*this.speed*0.5);
                if(d<(this.type==='boss'?600:400) && Math.random()<(this.type==='boss'?0.1:0.03)){
                    let dmg=this.type==='boss'?25:10;
                    bullets.push(new Bullet(this.x,this.y,{x:Math.cos(a)*BULLET_SPEED,y:Math.sin(a)*BULLET_SPEED},true,dmg,this.type==='boss'?8:4));
                    this.cooldown=40;
                }
            }
            takeDamage(amt) {
                this.hp-=amt;
                if(this.hp<=0 && !this.dead) {
                    this.dead=true; playerStats.totalKills++; addPlayerXp(this.type==='boss'?100:10);
                    createParticles(this.x,this.y,this.color);
                    if(Math.random()<0.3)drops.push(new DropItem(this.x,this.y,'coin'));
                    else if(Math.random()<0.2)drops.push(new DropItem(this.x,this.y,Math.random()<0.5?'medkit':'grenade'));
                }
            }
        }
        class Bullet {
            constructor(x, y, v, en, d, r=4, t=null) { this.x=x;this.y=y;this.v=v;this.isEnemy=en;this.dmg=d;this.dead=false;this.radius=r;this.specialType=t; }
            update() {
                this.x+=this.v.x; this.y+=this.v.y;
                if(!activeCheats.wallbang||this.isEnemy) for(let o of obstacles) if(this.x>o.x&&this.x<o.x+o.size&&this.y>o.y&&this.y<o.y+o.size){this.dead=true;if(this.specialType==='snowball')this.explode(); return;}
                if(this.x<0||this.x>canvas.width||this.y<0||this.y>canvas.height)this.dead=true;
            }
            draw() { ctx.beginPath(); ctx.arc(this.x,this.y,this.radius,0,Math.PI*2); ctx.fillStyle=this.specialType==='snowball'?'#FFF':(this.isEnemy?'orange':'#FF0'); ctx.fill(); }
            explode() { createExplosion(this.x,this.y); enemies.forEach(e=>{if(Math.hypot(e.x-this.x,e.y-this.y)<100)e.takeDamage(10000);}); }
        }
        function createParticles(x,y,c){for(let i=0;i<5;i++)particles.push({x,y,c,vx:(Math.random()-0.5)*7,vy:(Math.random()-0.5)*7,life:15});}
        function createExplosion(x,y){for(let i=0;i<30;i++)particles.push({x,y,c:i%2?'orange':'red',vx:(Math.random()-0.5)*15,vy:(Math.random()-0.5)*15,life:30}); particles.push({x,y,c:'rgba(255,255,255,0.8)',vx:0,vy:0,life:15,r:100,shock:true});}

        function selectPlatform(mode) {
            controlMode = mode; document.getElementById('platform-screen').style.display = 'none';
            loadGame(); showMainMenu(); setupMobileWeapons();
            if(mode==='MOBILE'){ document.getElementById('mobile-controls').style.display='block'; document.getElementById('weapon-info').style.display='none'; }
            else { document.getElementById('mobile-controls').style.display='none'; document.getElementById('weapon-info').style.display='block'; }
        }
        const weaponKeys = ['pistol', 'rifle', 'shotgun', 'sniper', 'minigun', 'snowball'];
        function updateUI() {
            if(player){
                if(controlMode==='PC')document.getElementById('weapon-info').innerText="–ó–±—Ä–æ—è: "+player.weapon.toUpperCase();
                document.getElementById('grenade-counter').innerText="üí£: "+player.grenades; document.getElementById('coin-counter').innerText="üí∞: "+playerStats.coins;
                document.getElementById('xp-fill').style.width=(playerStats.xp/playerStats.nextLevelXp)*100+'%'; document.getElementById('level-text').innerText="LVL "+playerStats.level;
                if(controlMode==='MOBILE') document.querySelectorAll('.wpn-btn').forEach(b=>{ let w=b.getAttribute('data-wpn'); b.className='wpn-btn'+(player.weapon===w?' active':'')+(playerStats.unlockedWeapons.includes(w)?'':' locked'); });
            }
        }
        function setupMobileWeapons(){
            const bar=document.getElementById('weapon-bar'); bar.innerHTML='';
            weaponKeys.forEach(k=>{ if(k==='snowball'&&!playerStats.unlockedWeapons.includes(k))return; 
            let d=document.createElement('div'); d.className='wpn-btn'; d.setAttribute('data-wpn',k); d.innerText=k==='snowball'?'‚ùÑÔ∏è':k.substr(0,3);
            d.onclick=()=>{if(player)player.trySetWeapon(k)}; bar.appendChild(d); });
        }
        function showMainMenu(){ gameState='MENU'; document.getElementById('menu-overlay').style.display='flex'; document.getElementById('game-ui').style.display='none'; document.getElementById('end-game-btn').style.display='none'; document.querySelector('.shop-btn').style.display='block'; document.getElementById('menu-buttons').style.display='grid'; updateMenuStats(); }
        function startMission(id){
            currentMissionId=id; gameState='PLAYING'; player=new Player(canvas.width/2,canvas.height/2);
            enemies=[]; bullets=[]; particles=[]; obstacles=[]; drops=[]; thrownGrenades=[]; gameTime=0; enemiesKilled=0; grenadesKilled=0; bossSpawned=false; zoneTimer=0;
            if(id===9){captureZone.x=canvas.width/2; captureZone.y=canvas.height/2;}
            for(let i=0;i<30;i++)decorations.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,size:Math.random()*20+10});
            for(let i=0;i<12;i++){ let s=40+Math.random()*60, x=50+Math.random()*(canvas.width-s-100), y=50+Math.random()*(canvas.height-s-100); if(Math.hypot(x-player.x,y-player.y)>200)obstacles.push(new Rect(x,y,s)); }
            let t="–ú—ñ—Å—ñ—è"; if(id===1)t="–í–∏–∂–∏—Ç–∏ 20—Å"; if(id===2)t="–í–±–∏—Ç–∏ 5"; if(id===3)t="–ë–û–°";
            document.getElementById('mission-text').innerText=t; document.getElementById('menu-overlay').style.display='none'; document.getElementById('game-ui').style.display='block'; updateUI();
        }
        function gameOver(win){ gameState='GAMEOVER'; saveGame(); document.getElementById('menu-overlay').style.display='flex'; document.getElementById('end-game-btn').style.display='block'; document.getElementById('menu-buttons').style.display='none'; document.querySelector('.shop-btn').style.display='none'; let t=document.getElementById('menu-title'); t.innerText=win?"–ü–ï–†–ï–ú–û–ì–ê":"–ü–û–†–ê–ó–ö–ê"; t.style.color=win?"#0F0":"red"; }
        function spawnEnemy(){ let s=Math.floor(Math.random()*4),x,y; if(s===0){x=Math.random()*canvas.width;y=-30;} if(s===1){x=canvas.width+30;y=Math.random()*canvas.height;} if(s===2){x=Math.random()*canvas.width;y=canvas.height+30;} if(s===3){x=-30;y=Math.random()*canvas.height;} enemies.push(new Enemy(x,y,currentMissionId===3&&!bossSpawned?'boss':'std')); if(currentMissionId===3)bossSpawned=true; }
        
        function updateGame(){
            if(gameState!=='PLAYING')return; gameTime+=1/60; snowflakes.forEach(f=>{f.y+=f.s;if(f.y>canvas.height)f.y=-10;});
            if(Math.floor(gameTime*60)%120===0)spawnEnemy();
            player.update();
            if(currentMissionId===1&&gameTime>=20)gameOver(true); if(currentMissionId===2&&enemiesKilled>=5)gameOver(true); if(currentMissionId===3&&bossSpawned&&!enemies.some(e=>e.type==='boss'))gameOver(true);
            
            document.getElementById('stats').innerText=gameTime.toFixed(0);
            drops.forEach((d,i)=>{if(Math.hypot(d.x-player.x,d.y-player.y)<35){ if(d.type==='coin')playerStats.coins+=10; else if(d.type==='grenade')player.grenades++; else player.hp+=25; drops.splice(i,1); updateUI(); }});
            enemies.forEach((e,i)=>{e.update();if(e.dead)enemies.splice(i,1);});
            thrownGrenades.forEach((g,i)=>{g.update();if(g.dead)thrownGrenades.splice(i,1);});
            bullets.forEach((b,i)=>{b.update(); let h=false; if(!b.isEnemy)enemies.forEach(e=>{if(!h&&Math.hypot(b.x-e.x,b.y-e.y)<e.radius+b.radius){e.takeDamage(b.dmg);h=true;}}); else if(Math.hypot(b.x-player.x,b.y-player.y)<20){player.hp-=b.dmg;h=true;screenShake=5;if(player.hp<=0)gameOver(false);} if(h||b.dead)bullets.splice(i,1);});
            particles.forEach((p,i)=>{if(p.shock){p.r+=5;p.life--;}else{p.x+=p.vx;p.y+=p.vy;p.life--;} if(p.life<=0)particles.splice(i,1);});
            if(screenShake>0)screenShake*=0.9;
        }
        function drawGame(){
            ctx.save(); if(screenShake>0.5)ctx.translate((Math.random()-0.5)*screenShake,(Math.random()-0.5)*screenShake);
            ctx.fillStyle='#1a1a2e'; ctx.fillRect(0,0,canvas.width,canvas.height);
            decorations.forEach(d=>{ctx.beginPath();ctx.arc(d.x,d.y,d.size,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,0.05)';ctx.fill();});
            if(currentMissionId===9){ctx.beginPath();ctx.arc(captureZone.x,captureZone.y,100,0,Math.PI*2);ctx.strokeStyle='#00F';ctx.stroke();}
            obstacles.forEach(o=>o.draw()); drops.forEach(d=>d.draw()); thrownGrenades.forEach(g=>g.draw());
            particles.forEach(p=>{if(p.shock){ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fillStyle=p.c;ctx.fill();}else{ctx.fillStyle=p.c;ctx.fillRect(p.x,p.y,3,3);}});
            bullets.forEach(b=>b.draw()); enemies.forEach(e=>e.draw()); if(activeCheats.wh)enemies.forEach(e=>{ctx.strokeStyle='red';ctx.strokeRect(e.x-e.radius,e.y-e.radius,e.radius*2,e.radius*2);});
            if(player.hp>0)player.draw();
            ctx.fillStyle='rgba(255,255,255,0.5)'; snowflakes.forEach(f=>{ctx.beginPath();ctx.arc(f.x,f.y,f.r,0,Math.PI*2);ctx.fill();});
            if(currentMissionId===10){let g=ctx.createRadialGradient(player.x,player.y,50,player.x,player.y,300);g.addColorStop(0,'rgba(0,0,0,0)');g.addColorStop(1,'rgba(0,0,0,0.95)');ctx.fillStyle=g;ctx.fillRect(0,0,canvas.width,canvas.height);}
            ctx.restore();
        }
        function loop(){ requestAnimationFrame(loop); if(gameState==='PLAYING'){updateGame();drawGame();} }

        window.addEventListener('keydown',e=>{if(controlMode==='PC')keys[e.code]=true;}); window.addEventListener('keyup',e=>{if(controlMode==='PC')keys[e.code]=false;});
        window.addEventListener('mousemove',e=>{if(controlMode==='PC'){mouse.x=e.clientX;mouse.y=e.clientY;}}); window.addEventListener('mousedown',()=>mouse.down=true); window.addEventListener('mouseup',()=>mouse.down=false);

        function handleJoystick(t,isLeft){
            let z=isLeft?document.getElementById('stick-left'):document.getElementById('stick-right'); let r=z.getBoundingClientRect();
            let dx=t.clientX-(r.left+r.width/2), dy=t.clientY-(r.top+r.height/2), d=Math.min(Math.hypot(dx,dy),r.width/2), a=Math.atan2(dy,dx);
            let k=isLeft?document.getElementById('knob-left'):document.getElementById('knob-right');
            k.style.transform=`translate(-50%,-50%) translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px)`;
            if(isLeft){joystickLeft.x=Math.cos(a)*(d/(r.width/2));joystickLeft.y=Math.sin(a)*(d/(r.width/2));joystickLeft.active=true;joystickLeft.id=t.identifier;}
            else{joystickRight.x=Math.cos(a)*(d/(r.width/2));joystickRight.y=Math.sin(a)*(d/(r.width/2));joystickRight.active=true;joystickRight.id=t.identifier;}
        }
        function resetJoystick(isLeft){
            if(isLeft){joystickLeft.active=false;joystickLeft.x=0;joystickLeft.y=0;document.getElementById('knob-left').style.transform='translate(-50%,-50%)';}
            else{joystickRight.active=false;joystickRight.x=0;joystickRight.y=0;document.getElementById('knob-right').style.transform='translate(-50%,-50%)';}
        }
        document.addEventListener('touchstart',e=>{if(controlMode!=='MOBILE'||gameState!=='PLAYING')return; for(let i=0;i<e.changedTouches.length;i++){let t=e.changedTouches[i]; if(t.target.id==='mobile-grenade-btn'||t.target.classList.contains('wpn-btn'))continue; let l=document.getElementById('stick-left').getBoundingClientRect(); if(t.clientX>=l.left&&t.clientX<=l.right&&t.clientY>=l.top&&t.clientY<=l.bottom)handleJoystick(t,true); let r=document.getElementById('stick-right').getBoundingClientRect(); if(t.clientX>=r.left&&t.clientX<=r.right&&t.clientY>=r.top&&t.clientY<=r.bottom)handleJoystick(t,false);} },{passive:false});
        document.addEventListener('touchmove',e=>{if(controlMode!=='MOBILE'||gameState!=='PLAYING')return; e.preventDefault(); for(let i=0;i<e.changedTouches.length;i++){let t=e.changedTouches[i]; if(t.identifier===joystickLeft.id)handleJoystick(t,true); if(t.identifier===joystickRight.id)handleJoystick(t,false);} },{passive:false});
        document.addEventListener('touchend',e=>{if(controlMode!=='MOBILE')return; for(let i=0;i<e.changedTouches.length;i++){let t=e.changedTouches[i]; if(t.identifier===joystickLeft.id)resetJoystick(true); if(t.identifier===joystickRight.id)resetJoystick(false);} });

        loop();
    </script>
</body>
</html>
