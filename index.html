<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Shooter: Online Account</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #222;
            font-family: 'Courier New', Courier, monospace;
            color: white;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        canvas { display: block; }
        
        /* UI */
        #game-ui {
            display: none;
            position: absolute;
            top: 10px; left: 10px;
            pointer-events: none;
            width: 100%;
            box-sizing: border-box;
            padding-right: 20px;
            z-index: 5;
        }
        #top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .stat-box {
            background: rgba(0,0,0,0.6);
            padding: 5px 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 16px;
        }
        #mission-text { font-size: 18px; font-weight: bold; color: #FFD700; text-shadow: 1px 1px 0 #000; }
        #weapon-info { color: #aaa; }
        #grenade-counter { color: #FFA500; font-weight: bold; }
        #coin-counter { color: #FFFF00; font-weight: bold; }
        
        #health-bar {
            margin-top: 5px; width: 150px; height: 15px;
            background: #444; border: 2px solid #fff;
        }
        #health-fill {
            width: 100%; height: 100%;
            background: #00FF00; transition: width 0.1s;
        }

        /* –ó–ê–ì–ê–õ–¨–ù–Ü –°–¢–ò–õ–Ü –ú–ï–ù–Æ */
        .overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; 
            z-index: 20;
        }
        h1 { margin-bottom: 5px; font-size: 28px; color: #0077FF; text-align: center; text-transform: uppercase; }
        h2 { margin-bottom: 10px; font-size: 16px; color: #aaa; }
        
        .btn {
            background: #222; color: white;
            border: 2px solid #0077FF; padding: 10px;
            font-size: 12px; cursor: pointer; width: 170px;
            text-align: center; font-family: inherit; margin: 2px;
        }
        .btn:hover { background: #0077FF; color: black; }
        
        /* –ï–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–Ü–á */
        #auth-screen { z-index: 50; }
        .auth-form {
            background: #333; padding: 20px; border: 2px solid #0077FF;
            display: flex; flex-direction: column; gap: 10px; width: 250px;
        }
        .auth-input {
            padding: 10px; background: #111; border: 1px solid #555; color: white; font-family: inherit;
        }
        .auth-msg { color: red; font-size: 12px; text-align: center; min-height: 15px; }

        /* –Ü–ù–®–Ü –ö–ù–û–ü–ö–ò */
        .boss-btn { border-color: #A020F0; color: #E0E0E0; }
        .hard-btn { border-color: #FF3333; color: #FFAAAA; }
        .grenade-mission-btn { border-color: #FFA500; color: #FFD700; }
        .shop-btn { border-color: #FFFF00; color: #FFFFAA; width: 350px; margin-top: 10px; font-size: 16px; font-weight: bold;}
        .cloud-btn { border-color: #00FFFF; color: #AAFFFF; width: 350px; margin-top: 5px;}

        /* –ú–ê–ì–ê–ó–ò–ù */
        #shop-screen { display: none; }
        .shop-container {
            display: flex; gap: 20px; width: 90%; max-width: 800px; justify-content: center; flex-wrap: wrap;
        }
        .shop-column { background: #333; padding: 15px; border: 2px solid #555; width: 300px; }
        .shop-item {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px;
        }
        .buy-btn {
            background: #222; border: 1px solid #FFFF00; color: #FFFF00; padding: 5px 10px; cursor: pointer; font-size: 12px;
        }
        .buy-btn.owned { background: #004400; border-color: #00FF00; color: white; cursor: default; }
        .buy-btn.equipped { background: #00FF00; color: black; font-weight: bold; }
        .buy-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: #555; color: #555; }
        
        .preview-area { display: flex; flex-direction: column; align-items: center; margin-bottom: 15px; }
        .menu-stats { color: #FFFF00; margin-bottom: 10px; font-size: 14px; border: 1px solid #555; padding: 10px; }
        .mission-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }

        /* –ú–û–ë–Ü–õ–¨–ù–ï –ö–ï–†–£–í–ê–ù–ù–Ø */
        #mobile-controls {
            display: none; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; pointer-events: none; z-index: 10;
        }
        .joystick-zone {
            position: absolute; bottom: 50px; width: 120px; height: 120px;
            background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; pointer-events: auto;
        }
        #stick-left { left: 30px; }
        #stick-right { right: 30px; }
        .joystick-knob {
            position: absolute; top: 50%; left: 50%; width: 50px; height: 50px;
            background: rgba(0, 119, 255, 0.5); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none;
        }
        #stick-right .joystick-knob { background: rgba(255, 51, 51, 0.5); }
        #mobile-grenade-btn {
            position: absolute; bottom: 120px; right: 160px; width: 60px; height: 60px;
            background: rgba(255, 165, 0, 0.3); border: 2px solid #FFA500;
            border-radius: 50%; color: #FFA500; font-size: 24px;
            display: flex; justify-content: center; align-items: center;
            pointer-events: auto; cursor: pointer;
        }
        #mobile-grenade-btn:active { background: #FFA500; color: black; }
        #weapon-bar {
            position: absolute; bottom: 10px; left: 50%;
            transform: translateX(-50%); display: flex; gap: 5px; pointer-events: auto;
        }
        .wpn-btn {
            width: 45px; height: 45px; background: #333; border: 1px solid #666;
            color: white; font-size: 10px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            border-radius: 5px; font-family: inherit; cursor: pointer;
        }
        .wpn-btn.active { border-color: #0077FF; background: #004488; }
        .wpn-btn.locked { opacity: 0.3; border-color: #333; cursor: not-allowed; }
    </style>
</head>
<body>

    <div id="auth-screen" class="overlay">
        <h1>Tactical Shooter</h1>
        <h2>–í—Ö—ñ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
        <div class="auth-form">
            <input type="text" id="auth-nick" class="auth-input" placeholder="–í–∞—à –ù—ñ–∫–Ω–µ–π–º">
            <input type="password" id="auth-pass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <div id="auth-msg" class="auth-msg"></div>
            <button class="btn" style="width: 100%;" onclick="attemptLogin()">–í–•–Ü–î / –†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø</button>
            <p style="font-size: 10px; color: #888; text-align: center; margin: 0;">–Ø–∫—â–æ –∞–∫–∞—É–Ω—Ç–∞ –Ω–µ–º–∞—î, –≤—ñ–Ω –±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.</p>
        </div>
    </div>

    <div id="platform-screen" class="overlay" style="z-index: 30; display: none;">
        <h1>–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ, <span id="welcome-nick" style="color: yellow;"></span></h1>
        <h2>–û–±–µ—Ä—ñ—Ç—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è</h2>
        <button class="btn" onclick="selectPlatform('PC')">üíª –ü–ö (–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞)</button>
        <button class="btn" onclick="selectPlatform('MOBILE')">üì± –¢–µ–ª–µ—Ñ–æ–Ω (–°–µ–Ω—Å–æ—Ä)</button>
        <button class="btn" onclick="logout()" style="margin-top: 20px; background: #550000; border-color: red;">–í–ò–ô–¢–ò –ó –ê–ö–ê–£–ù–¢–£</button>
    </div>

    <div id="shop-screen" class="overlay" style="z-index: 25; display: none;">
        <h1>–ú–ê–ì–ê–ó–ò–ù</h1>
        <div style="color: yellow; margin-bottom: 10px; font-size: 20px;">üí∞ –ë–ê–õ–ê–ù–°: <span id="shop-coins">0</span></div>
        <div class="shop-container">
            <div class="shop-column preview-area">
                <h3>–ó–û–í–ù–Ü–®–ù–Ü–°–¢–¨</h3>
                <canvas id="previewCanvas" width="150" height="150" style="border: 2px solid #555; background: #222; margin-bottom: 10px;"></canvas>
                <label>–ö–æ–ª—ñ—Ä:</label>
                <input type="color" id="colorPicker" value="#0077FF" onchange="updatePreview()">
            </div>
            <div class="shop-column">
                <h3>–ê–ö–°–ï–°–£–ê–†–ò</h3>
                <div id="accessories-list"></div>
            </div>
            <div class="shop-column">
                <h3>–ó–ë–†–û–Ø</h3>
                <div id="weapons-list"></div>
            </div>
        </div>
        <button class="btn" onclick="closeShop()" style="margin-top: 20px; width: 300px;">–ó–ë–ï–†–ï–ì–¢–ò –Ü –í–ò–ô–¢–ò</button>
    </div>

    <div id="menu-overlay" class="overlay" style="display: none;">
        <h1 id="menu-title">–ú–ï–ù–Æ –ú–Ü–°–Ü–ô</h1>
        <div class="menu-stats">
            –í–ë–ò–í–°–¢–í: <span id="menu-kills">0</span> | –ú–û–ù–ï–¢: <span id="menu-coins">0</span>
        </div>
        
        <div id="menu-buttons" class="mission-grid">
            <button class="btn" onclick="startMission(1)">–ú—ñ—Å—ñ—è 1: –û–∫–æ–ø<br><small>(20 —Å–µ–∫)</small></button>
            <button class="btn" onclick="startMission(2)">–ú—ñ—Å—ñ—è 2: –ó–∞—á–∏—Å—Ç–∫–∞<br><small>(5 –≤–æ—Ä–æ–≥—ñ–≤)</small></button>
            <button class="btn boss-btn" onclick="startMission(3)">–ú—ñ—Å—ñ—è 3: –ë–û–°<br><small>(–õ—ñ–∫–≤—ñ–¥–∞—Ü—ñ—è)</small></button>
            <button class="btn" onclick="startMission(4)">–ú—ñ—Å—ñ—è 4: –û–†–î–ê<br><small>(–í–∏–∂–∏—Ç–∏ 40—Å)</small></button>
            <button class="btn" onclick="startMission(5)">–ú—ñ—Å—ñ—è 5: –ú'–Ø–°–û<br><small>(–í–±–∏—Ç–∏ 50)</small></button>
            <button class="btn hard-btn" onclick="startMission(6)">–ú—ñ—Å—ñ—è 6: –•–ê–†–î<br><small>(60 —Å–µ–∫)</small></button>
            <button class="btn grenade-mission-btn" onclick="startMission(7)">–ú—ñ—Å—ñ—è 7: –ü–Ü–î–†–ò–í<br><small>(15 –≥—Ä–∞–Ω–∞—Ç–∞–º–∏)</small></button>
            <button class="btn hard-btn" onclick="startMission(8)">–ú—ñ—Å—ñ—è 8: –ê–ü–û–ö–ê–õ–Ü–ü–°–ò–°<br><small>(50 —Å–µ–∫)</small></button>
        </div>
        <button class="btn shop-btn" onclick="openShop()">üõí –ú–ê–ì–ê–ó–ò–ù –Ü –ó–ë–†–û–Ø</button>
        <button class="btn cloud-btn" onclick="exportSaveCode()">‚òÅÔ∏è –ó–ë–ï–†–ï–ì–¢–ò –£ –•–ú–ê–†–£ (–ö–û–î)</button>
        <button class="btn cloud-btn" onclick="importSaveCode()">üì• –ó–ê–í–ê–ù–¢–ê–ñ–ò–¢–ò –ö–û–î</button>
        
        <button id="end-game-btn" class="btn" onclick="showMainMenu()" style="display:none; background: #FF3333; margin-top: 20px;">–í –ì–û–õ–û–í–ù–ï –ú–ï–ù–Æ</button>
    </div>

    <div id="game-ui">
        <div id="top-bar">
            <div>
                <div id="mission-text">–¶—ñ–ª—å: ...</div>
                <div id="health-bar"><div id="health-fill"></div></div>
                <div class="stat-box" id="weapon-info">–ó–±—Ä–æ—è: –ü–Ü–°–¢–û–õ–ï–¢</div>
            </div>
            <div style="text-align: right;">
                <div class="stat-box" id="stats">–ß–∞—Å: 0.0</div>
                <div class="stat-box" id="grenade-counter">üí£: 3</div>
                <div class="stat-box" id="coin-counter">üí∞: 0</div>
            </div>
        </div>
    </div>

    <div id="mobile-controls">
        <div id="stick-left" class="joystick-zone"><div class="joystick-knob" id="knob-left"></div></div>
        <div id="stick-right" class="joystick-zone"><div class="joystick-knob" id="knob-right"></div></div>
        <div id="mobile-grenade-btn" onclick="throwGrenadeMobile()">üí£</div>
        <div id="weapon-bar"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- –°–ò–°–¢–ï–ú–ê –ê–ö–ê–£–ù–¢–Ü–í ---
        let currentUsername = null;
        let playerStats = {
            totalKills: 0, coins: 0, color: '#0077FF',
            unlockedWeapons: ['pistol', 'rifle', 'shotgun', 'sniper'],
            unlockedOutfits: ['none'], currentOutfit: 'none'
        };

        // –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (—ñ–º—ñ—Ç–∞—Ü—ñ—è –≤ localStorage)
        function getUsersDB() {
            return JSON.parse(localStorage.getItem('tactical_users_db')) || {};
        }
        function saveUsersDB(db) {
            localStorage.setItem('tactical_users_db', JSON.stringify(db));
        }

        function attemptLogin() {
            const nick = document.getElementById('auth-nick').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            const msg = document.getElementById('auth-msg');

            if (!nick || !pass) { msg.innerText = "–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫ —Ç–∞ –ø–∞—Ä–æ–ª—å!"; return; }

            const db = getUsersDB();
            
            if (db[nick]) {
                // –í—Ö—ñ–¥
                if (db[nick] === pass) {
                    loginSuccess(nick);
                } else {
                    msg.innerText = "–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å!";
                }
            } else {
                // –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
                db[nick] = pass;
                saveUsersDB(db);
                loginSuccess(nick);
            }
        }

        function loginSuccess(nick) {
            currentUsername = nick;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('platform-screen').style.display = 'flex';
            document.getElementById('welcome-nick').innerText = nick;
            loadGameData();
        }

        function logout() {
            currentUsername = null;
            document.getElementById('platform-screen').style.display = 'none';
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('auth-pass').value = '';
            document.getElementById('auth-msg').innerText = '';
        }

        function loadGameData() {
            if (!currentUsername) return;
            let saved = localStorage.getItem('tactical_save_' + currentUsername);
            if (saved) {
                playerStats = { ...playerStats, ...JSON.parse(saved) };
            } else {
                // –°–∫–∏–¥–∞–Ω–Ω—è –Ω–∞ –¥–µ—Ñ–æ–ª—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞
                playerStats = {
                    totalKills: 0, coins: 0, color: '#0077FF',
                    unlockedWeapons: ['pistol', 'rifle', 'shotgun', 'sniper'],
                    unlockedOutfits: ['none'], currentOutfit: 'none'
                };
            }
            updateMenuStats();
        }

        function saveGame() {
            if (!currentUsername) return;
            localStorage.setItem('tactical_save_' + currentUsername, JSON.stringify(playerStats));
            updateMenuStats();
        }

        // –•–ú–ê–†–ù–Ü –§–£–ù–ö–¶–Ü–á (–ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è —Ä—è–¥–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è)
        function exportSaveCode() {
            saveGame();
            const dataStr = JSON.stringify(playerStats);
            const encoded = btoa(unescape(encodeURIComponent(dataStr))); // Base64 encoding
            const fullCode = currentUsername + "|" + encoded;
            
            prompt("–°–∫–æ–ø—ñ—é–π—Ç–µ —Ü–µ–π –∫–æ–¥ —ñ –≤—Å—Ç–∞–≤—Ç–µ –Ω–∞ —ñ–Ω—à–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó:", fullCode);
        }

        function importSaveCode() {
            let code = prompt("–í—Å—Ç–∞–≤—Ç–µ –∫–æ–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:");
            if (!code) return;
            
            try {
                let parts = code.split('|');
                if (parts.length !== 2) throw new Error("–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç");
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω—ñ–∫–∞ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–∞, –∞–ª–µ –∫–æ—Ä–∏—Å–Ω–∞)
                // if (parts[0] !== currentUsername) { alert("–¶–µ–π –∫–æ–¥ –¥–ª—è —ñ–Ω—à–æ–≥–æ –∞–∫–∞—É–Ω—Ç—É!"); return; }

                let decoded = decodeURIComponent(escape(atob(parts[1])));
                playerStats = JSON.parse(decoded);
                saveGame();
                alert("–ü—Ä–æ–≥—Ä–µ—Å —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ!");
                updateMenuStats();
            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞! –ù–µ–≤—ñ—Ä–Ω–∏–π –∫–æ–¥.");
            }
        }

        function updateMenuStats() {
            document.getElementById('menu-kills').innerText = playerStats.totalKills;
            document.getElementById('menu-coins').innerText = playerStats.coins;
        }

        // --- –ú–ê–ì–ê–ó–ò–ù ---
        const shopItems = {
            outfits: [
                { id: 'none', name: '–ë–µ–∑ –µ–∫—ñ–ø—ñ—Ä—É–≤–∞–Ω–Ω—è', price: 0 },
                { id: 'cap', name: 'üß¢ –ö–µ–ø–∫–∞', price: 150 },
                { id: 'helmet', name: 'ü™ñ –ö–∞—Å–∫–∞', price: 300 },
                { id: 'vest', name: 'üõ°Ô∏è –ñ–∏–ª–µ—Ç', price: 500 }
            ],
            weapons: [
                { id: 'minigun', name: '–ö–£–õ–ï–ú–ï–¢', price: 1000 }
            ]
        };

        // --- –ö–û–ù–°–¢–ê–ù–¢–ò ---
        const PLAYER_SPEED = 4.5;
        const ENEMY_SPEED = 2.5;
        const BULLET_SPEED = 14;
        
        // --- –°–¢–ê–ù ---
        let controlMode = 'PC';
        let gameState = 'AUTH'; // –°—Ç–∞—Ä—Ç—É—î–º–æ –∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
        let currentMissionId = 0;
        let gameTime = 0;
        let enemiesKilled = 0;
        let grenadesKilled = 0;
        let bossSpawned = false;
        
        let obstacles = [];
        let bullets = [];
        let enemies = [];
        let particles = [];
        let drops = [];
        let thrownGrenades = [];
        let player;

        // –í–≤—ñ–¥
        let keys = {};
        let mouse = { x: 0, y: 0, down: false };
        let joystickLeft = { x: 0, y: 0, active: false, id: null };
        let joystickRight = { x: 0, y: 0, active: false, id: null };
        let lastAimAngle = 0;

        // --- –ö–õ–ê–°–ò ---
        class DropItem {
            constructor(x, y, type) {
                this.x = x; this.y = y; this.type = type;
                this.size = 20; this.bobOffset = Math.random() * Math.PI * 2;
            }
            draw() {
                let bob = Math.sin(gameTime * 5 + this.bobOffset) * 3;
                let Y = this.y + bob;
                if (this.type === 'medkit') {
                    ctx.fillStyle = '#00CC00'; ctx.fillRect(this.x - 10, Y - 10, 20, 20);
                    ctx.fillStyle = '#FFF'; ctx.fillRect(this.x - 3, Y - 8, 6, 16); ctx.fillRect(this.x - 8, Y - 3, 16, 6);
                } else if (this.type === 'grenade') {
                    ctx.fillStyle = '#FFA500'; ctx.fillRect(this.x - 10, Y - 10, 20, 20);
                    ctx.fillStyle = '#000'; ctx.font = "16px Arial"; ctx.fillText("üí£", this.x - 9, Y + 6);
                } else if (this.type === 'coin') {
                    ctx.fillStyle = '#FFFF00'; ctx.beginPath(); ctx.arc(this.x, Y, 10, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = '#DAA520'; ctx.lineWidth = 2; ctx.stroke();
                    ctx.fillStyle = '#000'; ctx.font = "bold 14px Arial"; ctx.fillText("$", this.x - 4, Y + 5);
                }
                if (this.type !== 'coin') { ctx.strokeStyle = '#FFF'; ctx.lineWidth = 1; ctx.strokeRect(this.x - 10, Y - 10, 20, 20); }
            }
        }

        class GrenadeObj {
            constructor(x, y, tx, ty) {
                this.x = x; this.y = y; this.tx = tx; this.ty = ty;
                this.timer = 60; this.dead = false;
                const angle = Math.atan2(ty - y, tx - x);
                const dist = Math.hypot(tx - x, ty - y);
                const speed = Math.min(dist / 20, 10);
                this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed;
                this.flyTime = Math.floor(dist / speed);
            }
            update() {
                if (this.flyTime > 0) { this.x += this.vx; this.y += this.vy; this.flyTime--; }
                this.timer--;
                if (this.timer <= 0) { this.explode(); this.dead = true; }
            }
            explode() {
                createExplosion(this.x, this.y);
                enemies.forEach(en => {
                    let d = Math.hypot(en.x - this.x, en.y - this.y);
                    if (d < 120) { en.hp -= 150; if (en.hp <= 0) grenadesKilled++; }
                });
            }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, 6, 0, Math.PI*2);
                ctx.fillStyle = Math.floor(this.timer / 5) % 2 === 0 ? 'red' : 'yellow';
                ctx.fill(); ctx.strokeStyle = '#000'; ctx.stroke();
            }
        }

        class Rect {
            constructor(x, y, size) { this.x = x; this.y = y; this.size = size; }
            draw() {
                ctx.fillStyle = '#444'; ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.strokeStyle = '#222'; ctx.lineWidth = 3; ctx.strokeRect(this.x, this.y, this.size, this.size);
                ctx.beginPath(); ctx.strokeStyle = '#333';
                ctx.moveTo(this.x, this.y); ctx.lineTo(this.x+this.size, this.y+this.size); ctx.stroke();
            }
        }

        class Entity {
            constructor(x, y, radius, color, hp) {
                this.x = x; this.y = y; this.radius = radius;
                this.color = color; this.hp = hp; this.maxHp = hp;
                this.dead = false; this.cooldown = 0;
            }
            drawBase() {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color; ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
            }
            drawHealthBar() {
                if (this.hp < this.maxHp) {
                    let w = this.radius * 2;
                    ctx.fillStyle = 'red'; ctx.fillRect(this.x - w/2, this.y - this.radius - 12, w, 4);
                    ctx.fillStyle = '#0f0'; ctx.fillRect(this.x - w/2, this.y - this.radius - 12, w * (this.hp / this.maxHp), 4);
                }
            }
            move(dx, dy) {
                if (!this.checkWallCollision(this.x + dx, this.y)) this.x += dx;
                if (!this.checkWallCollision(this.x, this.y + dy)) this.y += dy;
                if (this.x < this.radius) this.x = this.radius;
                if (this.x > canvas.width - this.radius) this.x = canvas.width - this.radius;
                if (this.y < this.radius) this.y = this.radius;
                if (this.y > canvas.height - this.radius) this.y = canvas.height - this.radius;
            }
            checkWallCollision(x, y) {
                for (let obs of obstacles) {
                    let cx = Math.max(obs.x, Math.min(x, obs.x + obs.size));
                    let cy = Math.max(obs.y, Math.min(y, obs.y + obs.size));
                    let dist = (x - cx)**2 + (y - cy)**2;
                    if (dist < this.radius**2) return true;
                }
                return false;
            }
        }

        class Player extends Entity {
            constructor(x, y) {
                super(x, y, 15, playerStats.color, 100);
                this.weapon = 'pistol'; 
                this.grenades = 3;
                this.grenadeCooldown = 0;
                this.angle = 0;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = playerStats.color; ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();

                if (playerStats.currentOutfit === 'helmet') {
                    ctx.fillStyle = '#334400'; ctx.beginPath(); ctx.arc(0, 0, this.radius + 1, Math.PI, 0); ctx.fill();
                    ctx.fillStyle = '#223300'; ctx.fillRect(-this.radius, -5, this.radius*2, 5);
                } else if (playerStats.currentOutfit === 'vest') {
                    ctx.fillStyle = '#2E3B22'; ctx.fillRect(-14, -14, 28, 28);
                    ctx.fillStyle = '#4A5D3A'; ctx.fillRect(-10, 2, 8, 10); ctx.fillRect(2, 2, 8, 10);
                    ctx.fillStyle = '#1A2512'; ctx.fillRect(-12, -14, 6, 8); ctx.fillRect(6, -14, 6, 8);
                } else if (playerStats.currentOutfit === 'cap') {
                    ctx.fillStyle = '#C2B280'; ctx.beginPath(); ctx.arc(0, 0, this.radius, Math.PI * 0.8, Math.PI * 3.2); ctx.fill();
                    ctx.fillStyle = '#A09165'; ctx.fillRect(13, -13, 14, 26);
                    ctx.beginPath(); ctx.arc(0,0,3,0,Math.PI*2); ctx.fillStyle='#8C7D54'; ctx.fill();
                }
                ctx.fillStyle = '#000'; ctx.fillRect(10, -3, 15, 6);
                ctx.restore();
                this.drawHealthBar();
            }
            update() {
                if (this.cooldown > 0) this.cooldown--;
                if (this.grenadeCooldown > 0) this.grenadeCooldown--;
                let dx = 0, dy = 0;
                if (controlMode === 'PC') {
                    if (keys['Digit1']) this.trySetWeapon('pistol');
                    if (keys['Digit2']) this.trySetWeapon('rifle');
                    if (keys['Digit3']) this.trySetWeapon('shotgun');
                    if (keys['Digit4']) this.trySetWeapon('sniper');
                    if (keys['Digit5']) this.trySetWeapon('minigun');
                    if (keys['Space']) this.throwGrenade(mouse.x, mouse.y);
                    if (keys['KeyW'] || keys['ArrowUp']) dy = -PLAYER_SPEED;
                    if (keys['KeyS'] || keys['ArrowDown']) dy = PLAYER_SPEED;
                    if (keys['KeyA'] || keys['ArrowLeft']) dx = -PLAYER_SPEED;
                    if (keys['KeyD'] || keys['ArrowRight']) dx = PLAYER_SPEED;
                    if (dx && dy) { dx *= 0.707; dy *= 0.707; }
                    this.angle = Math.atan2(mouse.y - this.y, mouse.x - this.x);
                    if (mouse.down) this.shootInput(this.angle);
                    lastAimAngle = this.angle;
                } else {
                    if (joystickLeft.active) { dx = joystickLeft.x * PLAYER_SPEED; dy = joystickLeft.y * PLAYER_SPEED; }
                    if (joystickRight.active) { this.angle = Math.atan2(joystickRight.y, joystickRight.x); lastAimAngle = this.angle; this.shootInput(this.angle); } 
                    else if (dx !== 0 || dy !== 0) { this.angle = Math.atan2(dy, dx); }
                }
                this.move(dx, dy);
            }
            trySetWeapon(wpn) { if (playerStats.unlockedWeapons.includes(wpn)) { this.weapon = wpn; updateUI(); } }
            throwGrenade(tx, ty) { if (this.grenades > 0 && this.grenadeCooldown <= 0) { this.grenades--; this.grenadeCooldown = 60; thrownGrenades.push(new GrenadeObj(this.x, this.y, tx, ty)); updateUI(); } }
            shootInput(angle) {
                if (this.cooldown > 0) return;
                if (this.weapon === 'pistol') this.spawnBullet(angle, 0, 20, 20); 
                else if (this.weapon === 'rifle') this.spawnBullet(angle, (Math.random()-0.5)*0.2, 10, 6);
                else if (this.weapon === 'shotgun') { this.spawnBullet(angle, 0, 15, 45); this.spawnBullet(angle + 0.15, 0, 15, 45); this.spawnBullet(angle - 0.15, 0, 15, 45); }
                else if (this.weapon === 'sniper') this.spawnBullet(angle, 0, 100, 60, 25);
                else if (this.weapon === 'minigun') this.spawnBullet(angle, (Math.random()-0.5)*0.4, 8, 3);
            }
            spawnBullet(angle, spread, dmg, cd, speed = BULLET_SPEED) {
                const finalAngle = angle + spread;
                const vel = { x: Math.cos(finalAngle) * speed, y: Math.sin(finalAngle) * speed };
                bullets.push(new Bullet(this.x, this.y, vel, false, dmg));
                this.cooldown = cd;
                if(this.weapon === 'sniper') { ctx.translate((Math.random()-0.5)*5, (Math.random()-0.5)*5); setTimeout(()=>ctx.setTransform(1,0,0,1,0,0), 50); }
            }
        }

        class Enemy extends Entity {
            constructor(x, y, isBoss = false) {
                let size = isBoss ? 40 : 15;
                let hp = isBoss ? 600 : 40;
                let color = isBoss ? '#A020F0' : '#FF3333';
                super(x, y, size, color, hp);
                this.isBoss = isBoss;
                this.speed = isBoss ? 1.5 : (currentMissionId === 6 ? 3.5 : (currentMissionId === 8 ? 3.0 : ENEMY_SPEED));
            }
            draw() {
                let angle = 0;
                if (player && !player.dead) angle = Math.atan2(player.y - this.y, player.x - this.x);
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(angle);
                let originX = this.x; let originY = this.y;
                this.x = 0; this.y = 0; super.drawBase(); this.x = originX; this.y = originY;
                ctx.fillStyle = this.isBoss ? '#4A004A' : '#550000';
                let gunL = this.isBoss ? 25 : 15; let gunW = this.isBoss ? 10 : 6;
                ctx.fillRect(this.radius - 2, -gunW/2, gunL, gunW);
                ctx.restore(); this.drawHealthBar();
            }
            update() {
                if (this.cooldown > 0) this.cooldown--;
                const dist = Math.hypot(player.x - this.x, player.y - this.y);
                const angle = Math.atan2(player.y - this.y, player.x - this.x);
                if (dist > 150 + this.radius) this.move(Math.cos(angle) * this.speed, Math.sin(angle) * this.speed);
                else if (dist < 100) this.move(-Math.cos(angle) * (this.speed*0.5), -Math.sin(angle) * (this.speed*0.5));
                let shootDist = this.isBoss ? 600 : 400; let chance = this.isBoss ? 0.1 : 0.03;
                if (dist < shootDist && Math.random() < chance) {
                    const shotAngle = angle + (Math.random()-0.5)*(this.isBoss ? 0.1 : 0.3);
                    const vel = { x: Math.cos(shotAngle) * BULLET_SPEED, y: Math.sin(shotAngle) * BULLET_SPEED };
                    let dmg = this.isBoss ? 25 : 10;
                    bullets.push(new Bullet(this.x, this.y, vel, true, dmg, this.isBoss ? 8 : 4));
                    this.cooldown = 40;
                }
            }
        }

        class Bullet {
            constructor(x, y, vel, isEnemy, dmg, radius = 4) {
                this.x = x; this.y = y; this.vel = vel; this.isEnemy = isEnemy; this.dmg = dmg; this.dead = false; this.radius = radius;
            }
            update() {
                this.x += this.vel.x; this.y += this.vel.y;
                for (let obs of obstacles) {
                    if (this.x > obs.x && this.x < obs.x + obs.size && this.y > obs.y && this.y < obs.y + obs.size) { this.dead = true; createParticles(this.x, this.y, '#888'); return; }
                }
                if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) this.dead = true;
            }
            draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2); ctx.fillStyle = this.isEnemy ? (this.radius > 4 ? '#A020F0' : 'orange') : '#FFFF00'; ctx.fill(); }
        }

        function createParticles(x, y, color) { for(let i=0; i<5; i++) particles.push({x, y, color, vx:(Math.random()-0.5)*7, vy:(Math.random()-0.5)*7, life:15}); }
        function createExplosion(x, y) { for(let i=0; i<30; i++) particles.push({x, y, color: i%2===0?'orange':'red', vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15, life:30}); particles.push({x, y, color: 'rgba(255,100,0,0.5)', vx:0, vy:0, life:10, radius: 100, isShockwave: true}); }

        // --- –õ–û–ì–Ü–ö–ê –ú–ê–ì–ê–ó–ò–ù–£ ---
        const pCtx = document.getElementById('previewCanvas').getContext('2d');
        function openShop() { document.getElementById('menu-overlay').style.display = 'none'; document.getElementById('shop-screen').style.display = 'flex'; document.getElementById('shop-coins').innerText = playerStats.coins; renderShopItems(); updatePreview(); }
        function closeShop() { saveGame(); document.getElementById('shop-screen').style.display = 'none'; document.getElementById('menu-overlay').style.display = 'flex'; }

        function renderShopItems() {
            const accList = document.getElementById('accessories-list'); accList.innerHTML = '';
            shopItems.outfits.forEach(item => {
                let div = document.createElement('div'); div.className = 'shop-item';
                let owned = playerStats.unlockedOutfits.includes(item.id); let equipped = playerStats.currentOutfit === item.id;
                let btnText = owned ? (equipped ? '–û–î–Ø–ì–ù–ï–ù–û' : '–û–î–Ø–ì–¢–ò') : `–ö–£–ü–ò–¢–ò (${item.price}$)`;
                let btnClass = equipped ? 'buy-btn equipped' : (owned ? 'buy-btn owned' : 'buy-btn');
                div.innerHTML = `<span>${item.name}</span> <button class="${btnClass}" onclick="handleShopAction('outfit', '${item.id}', ${item.price})">${btnText}</button>`;
                accList.appendChild(div);
            });
            const wpnList = document.getElementById('weapons-list'); wpnList.innerHTML = '';
            shopItems.weapons.forEach(item => {
                let div = document.createElement('div'); div.className = 'shop-item';
                let owned = playerStats.unlockedWeapons.includes(item.id);
                let btnText = owned ? '–ö–£–ü–õ–ï–ù–û' : `–ö–£–ü–ò–¢–ò (${item.price}$)`;
                let btnClass = owned ? 'buy-btn owned' : 'buy-btn';
                div.innerHTML = `<span>${item.name}</span> <button class="${btnClass}" onclick="handleShopAction('weapon', '${item.id}', ${item.price})" ${owned ? 'disabled' : ''}>${btnText}</button>`;
                wpnList.appendChild(div);
            });
        }
        function handleShopAction(type, id, price) {
            if (type === 'outfit') {
                if (playerStats.unlockedOutfits.includes(id)) { playerStats.currentOutfit = id; }
                else if (playerStats.coins >= price) { playerStats.coins -= price; playerStats.unlockedOutfits.push(id); playerStats.currentOutfit = id; }
                else alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –≥—Ä–æ—à–µ–π!");
            } else if (type === 'weapon') {
                if (!playerStats.unlockedWeapons.includes(id)) {
                    if (playerStats.coins >= price) { playerStats.coins -= price; playerStats.unlockedWeapons.push(id); }
                    else alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –≥—Ä–æ—à–µ–π!");
                }
            }
            updatePreview(); renderShopItems(); document.getElementById('shop-coins').innerText = playerStats.coins;
        }
        function updatePreview() {
            let color = document.getElementById('colorPicker').value; playerStats.color = color;
            pCtx.clearRect(0,0,150,150); pCtx.save(); pCtx.translate(75, 75); pCtx.scale(3, 3);
            pCtx.beginPath(); pCtx.arc(0, 0, 15, 0, Math.PI * 2); pCtx.fillStyle = color; pCtx.fill(); pCtx.strokeStyle = '#000'; pCtx.lineWidth = 1; pCtx.stroke();
            if (playerStats.currentOutfit === 'helmet') { pCtx.fillStyle = '#334400'; pCtx.beginPath(); pCtx.arc(0, 0, 16, Math.PI, 0); pCtx.fill(); pCtx.fillStyle = '#223300'; pCtx.fillRect(-15, -5, 30, 5); }
            else if (playerStats.currentOutfit === 'vest') { pCtx.fillStyle = '#2E3B22'; pCtx.fillRect(-14, -14, 28, 28); pCtx.fillStyle = '#4A5D3A'; pCtx.fillRect(-10, 2, 8, 10); pCtx.fillRect(2, 2, 8, 10); pCtx.fillStyle = '#1A2512'; pCtx.fillRect(-12, -14, 6, 8); pCtx.fillRect(6, -14, 6, 8); }
            else if (playerStats.currentOutfit === 'cap') { pCtx.fillStyle = '#C2B280'; pCtx.beginPath(); pCtx.arc(0, 0, 15, Math.PI * 0.8, Math.PI * 3.2); pCtx.fill(); pCtx.fillStyle = '#A09165'; pCtx.fillRect(13, -13, 14, 26); pCtx.beginPath(); pCtx.arc(0,0,3,0,Math.PI*2); pCtx.fillStyle='#8C7D54'; pCtx.fill(); }
            pCtx.fillStyle = '#000'; pCtx.fillRect(10, -3, 15, 6); pCtx.restore();
        }

        function selectPlatform(mode) {
            controlMode = mode; document.getElementById('platform-screen').style.display = 'none';
            showMainMenu(); setupMobileWeapons();
            if (mode === 'MOBILE') { document.getElementById('mobile-controls').style.display = 'block'; document.getElementById('weapon-info').style.display = 'none'; }
            else { document.getElementById('mobile-controls').style.display = 'none'; document.getElementById('weapon-info').style.display = 'block'; }
        }
        const weaponNames = { 'pistol': '–ü–Ü–°–¢–û–õ–ï–¢', 'rifle': '–ê–í–¢–û–ú–ê–¢', 'shotgun': '–î–†–û–ë–û–í–ò–ö', 'sniper': '–°–ù–ê–ô–ü–ï–†–ö–ê', 'minigun': '–ö–£–õ–ï–ú–ï–¢' };
        const weaponKeys = ['pistol', 'rifle', 'shotgun', 'sniper', 'minigun'];
        function updateUI() {
            if (player) {
                if (controlMode === 'PC') document.getElementById('weapon-info').innerText = "–ó–±—Ä–æ—è: " + weaponNames[player.weapon];
                document.getElementById('grenade-counter').innerText = "üí£: " + player.grenades;
                document.getElementById('coin-counter').innerText = "üí∞: " + playerStats.coins;
                if (controlMode === 'MOBILE') {
                     document.querySelectorAll('.wpn-btn').forEach(btn => {
                         let wpn = btn.getAttribute('data-wpn');
                         btn.className = 'wpn-btn' + (player.weapon === wpn ? ' active' : '') + (!playerStats.unlockedWeapons.includes(wpn) ? ' locked' : '');
                     });
                }
            }
        }
        function setupMobileWeapons() {
            const bar = document.getElementById('weapon-bar'); bar.innerHTML = '';
            weaponKeys.forEach(key => {
                let div = document.createElement('div'); div.className = 'wpn-btn'; div.setAttribute('data-wpn', key);
                div.innerText = key.substr(0,4); div.onclick = function() { setWeapon(key, this); }; bar.appendChild(div);
            });
        }
        function setWeapon(wpn, btn) { if (!player) return; if (playerStats.unlockedWeapons.includes(wpn)) { player.weapon = wpn; updateUI(); } }
        function spawnEnemyEdge(isBoss = false) {
            let side = Math.floor(Math.random() * 4); let x, y;
            switch(side) { case 0: x = Math.random() * canvas.width; y = -30; break; case 1: x = canvas.width + 30; y = Math.random() * canvas.height; break; case 2: x = Math.random() * canvas.width; y = canvas.height + 30; break; case 3: x = -30; y = Math.random() * canvas.height; break; }
            enemies.push(new Enemy(x, y, isBoss));
        }

        // INPUT
        window.addEventListener('keydown', e => { if(controlMode==='PC') keys[e.code] = true; });
        window.addEventListener('keyup', e => { if(controlMode==='PC') keys[e.code] = false; });
        window.addEventListener('mousemove', e => { if(controlMode==='PC') { mouse.x = e.clientX; mouse.y = e.clientY; }});
        window.addEventListener('mousedown', () => { if(controlMode==='PC') mouse.down = true; });
        window.addEventListener('mouseup', () => { if(controlMode==='PC') mouse.down = false; });
        function handleJoystick(touch, isLeft) {
            const zone = isLeft ? document.getElementById('stick-left') : document.getElementById('stick-right');
            const rect = zone.getBoundingClientRect(); const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
            let dx = touch.clientX - centerX; let dy = touch.clientY - centerY;
            const maxDist = rect.width / 2; const dist = Math.min(Math.hypot(dx, dy), maxDist); const angle = Math.atan2(dy, dx);
            const inputX = Math.cos(angle) * (dist / maxDist); const inputY = Math.sin(angle) * (dist / maxDist);
            const knob = isLeft ? document.getElementById('knob-left') : document.getElementById('knob-right');
            knob.style.transform = `translate(-50%, -50%) translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
            if (isLeft) { joystickLeft.x = inputX; joystickLeft.y = inputY; joystickLeft.active = true; joystickLeft.id = touch.identifier; }
            else { joystickRight.x = inputX; joystickRight.y = inputY; joystickRight.active = true; joystickRight.id = touch.identifier; }
        }
        function resetJoystick(isLeft) {
            if (isLeft) { joystickLeft.active = false; joystickLeft.x = 0; joystickLeft.y = 0; document.getElementById('knob-left').style.transform = `translate(-50%, -50%)`; }
            else { joystickRight.active = false; joystickRight.x = 0; joystickRight.y = 0; document.getElementById('knob-right').style.transform = `translate(-50%, -50%)`; }
        }
        document.addEventListener('touchstart', e => { if (controlMode !== 'MOBILE' || gameState !== 'PLAYING') return; for (let i = 0; i < e.changedTouches.length; i++) { let t = e.changedTouches[i]; if (t.target.id === 'mobile-grenade-btn' || t.target.classList.contains('wpn-btn')) continue; let zL = document.getElementById('stick-left').getBoundingClientRect(); if (t.clientX >= zL.left && t.clientX <= zL.right && t.clientY >= zL.top && t.clientY <= zL.bottom) handleJoystick(t, true); let zR = document.getElementById('stick-right').getBoundingClientRect(); if (t.clientX >= zR.left && t.clientX <= zR.right && t.clientY >= zR.top && t.clientY <= zR.bottom) handleJoystick(t, false); } }, {passive: false});
        document.addEventListener('touchmove', e => { if (controlMode !== 'MOBILE' || gameState !== 'PLAYING') return; e.preventDefault(); for (let i = 0; i < e.changedTouches.length; i++) { let t = e.changedTouches[i]; if (t.identifier === joystickLeft.id) handleJoystick(t, true); if (t.identifier === joystickRight.id) handleJoystick(t, false); } }, {passive: false});
        document.addEventListener('touchend', e => { if (controlMode !== 'MOBILE') return; for (let i = 0; i < e.changedTouches.length; i++) { let t = e.changedTouches[i]; if (t.identifier === joystickLeft.id) resetJoystick(true); if (t.identifier === joystickRight.id) resetJoystick(false); } });

        loop();
    </script>
</body>
</html>
